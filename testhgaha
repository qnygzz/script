--[[
    Custom UI Library (Linoria-like)
    Features:
    - Window, Tabs, Groupboxes (left/right/tabbox)
    - Toggle, Slider, Dropdown, ColorPicker, KeyPicker, Input, Button, Label, Divider
    - Dependency system (hide/show based on toggle)
    - Notification system
    - Full HSV color picker with sliders and preview
    - Keybind recorder
    - Theme manager (basic)
    - Save manager (needs executor file support)
    Fully self-contained, ready to use.
--]]

-- Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer

-- ------------------------------------------------------------------
-- Library core table
-- ------------------------------------------------------------------
local Library = {
    Flags = {},
    Connections = {},
    Tabs = {},
    ActiveTab = nil,
    Theme = {
        Background = Color3.fromRGB(25, 25, 25),
        Topbar = Color3.fromRGB(20, 20, 20),
        Element = Color3.fromRGB(45, 45, 45),
        Accent = Color3.fromRGB(0, 160, 255),
        Text = Color3.fromRGB(255, 255, 255),
        Shadow = Color3.fromRGB(0, 0, 0),
        Danger = Color3.fromRGB(255, 50, 50),
    },
    Options = {},
    Unloaded = false,
    CurrentMenu = nil,
    KeyRecorderActive = false,
    KeyRecorderCallback = nil,
    Notifications = {},
}

-- Utility functions
function Library:Create(className, props)
    local obj = Instance.new(className)
    for prop, val in pairs(props) do
        obj[prop] = val
    end
    return obj
end

function Library:Round(number, precision)
    precision = 10 ^ (precision or 0)
    return math.floor(number * precision + 0.5) / precision
end

function Library:AddConnection(signal, func)
    local conn = signal:Connect(func)
    table.insert(self.Connections, conn)
    return conn
end

function Library:Unload()
    self.Unloaded = true
    for _, conn in ipairs(self.Connections) do
        pcall(conn.Disconnect, conn)
    end
    if self.CurrentMenu and self.CurrentMenu.GUI then
        pcall(self.CurrentMenu.GUI.Destroy, self.CurrentMenu.GUI)
    end
    self.Flags = {}
    self.Tabs = {}
    self.Options = {}
end

-- ------------------------------------------------------------------
-- Notification System
-- ------------------------------------------------------------------
function Library:Notify(text, duration)
    duration = duration or 3
    if not self.CurrentMenu then return end
    local gui = self.CurrentMenu.GUI
    if not gui then return end

    local notifHolder = gui:FindFirstChild("NotificationHolder")
    if not notifHolder then
        notifHolder = Library:Create("Frame", {
            Name = "NotificationHolder",
            Size = UDim2.new(0, 300, 0, 0),
            Position = UDim2.new(1, -310, 0, 10),
            BackgroundTransparency = 1,
            Parent = gui,
            ZIndex = 100
        })
        local layout = Library:Create("UIListLayout", {
            FillDirection = Enum.FillDirection.Vertical,
            HorizontalAlignment = Enum.HorizontalAlignment.Right,
            VerticalAlignment = Enum.VerticalAlignment.Top,
            Padding = UDim.new(0, 5),
            Parent = notifHolder
        })
    end

    local notif = Library:Create("Frame", {
        Size = UDim2.new(0, 300, 0, 40),
        BackgroundColor3 = self.Theme.Background,
        BorderSizePixel = 0,
        Parent = notifHolder,
        ZIndex = 101
    })

    local corner = Library:Create("UICorner", {CornerRadius = UDim.new(0, 4), Parent = notif})
    local stroke = Library:Create("UIStroke", {Thickness = 1, Color = self.Theme.Accent, Parent = notif})

    local label = Library:Create("TextLabel", {
        Size = UDim2.new(1, -20, 1, 0),
        Position = UDim2.new(0, 10, 0, 0),
        BackgroundTransparency = 1,
        Text = text,
        TextColor3 = self.Theme.Text,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        TextWrapped = true,
        Parent = notif
    })

    -- Auto-destroy after duration
    task.delay(duration, function()
        if notif and notif.Parent then
            notif:TweenPosition(UDim2.new(1, 10, 0, 0), "Out", "Quad", 0.3, true, function()
                notif:Destroy()
            end)
        end
    end)

    -- Slide in animation
    notif.Position = UDim2.new(1, 10, 0, 0)
    notif:TweenPosition(UDim2.new(0, 0, 0, 0), "Out", "Quad", 0.3, true)
end

-- ------------------------------------------------------------------
-- KeyRecorder for KeyPicker
-- ------------------------------------------------------------------
local KeyRecorder = {}
KeyRecorder.__index = KeyRecorder

function KeyRecorder.new(callback)
    local self = setmetatable({}, KeyRecorder)
    self.Callback = callback
    self.Active = true
    Library.KeyRecorderActive = true
    Library.KeyRecorderCallback = function(key)
        if self.Active then
            self.Active = false
            Library.KeyRecorderActive = false
            Library.KeyRecorderCallback = nil
            self.Callback(key)
        end
    end
    return self
end

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if Library.KeyRecorderActive and Library.KeyRecorderCallback then
        if input.UserInputType == Enum.UserInputType.Keyboard then
            Library.KeyRecorderCallback(input.KeyCode)
        elseif input.UserInputType == Enum.UserInputType.MouseButton1 then
            Library.KeyRecorderCallback(input.UserInputType)
        elseif input.UserInputType == Enum.UserInputType.MouseButton2 then
            Library.KeyRecorderCallback(input.UserInputType)
        elseif input.UserInputType == Enum.UserInputType.MouseButton3 then
            Library.KeyRecorderCallback(input.UserInputType)
        end
    end
end)

-- ------------------------------------------------------------------
-- ColorPicker popup (HSV sliders)
-- ------------------------------------------------------------------
local ColorPicker = {}
ColorPicker.__index = ColorPicker

function ColorPicker.new(title, defaultColor, callback)
    local self = setmetatable({}, ColorPicker)
    self.Title = title or "Color Picker"
    self.Color = defaultColor or Color3.new(1,1,1)
    self.Callback = callback
    self.Open = false
    return self
end

function ColorPicker:RGBToHSV(color)
    local h, s, v = color:ToHSV()
    return h * 360, s * 100, v * 100
end

function ColorPicker:HSVToRGB(h, s, v)
    return Color3.fromHSV(h/360, s/100, v/100)
end

function ColorPicker:Open(parent)
    if self.Open then return end
    self.Open = true

    local gui = Library.CurrentMenu.GUI
    local overlay = Library:Create("Frame", {
        Size = UDim2.new(1,0,1,0),
        BackgroundColor3 = Color3.new(0,0,0),
        BackgroundTransparency = 0.5,
        Active = true,
        Parent = gui,
        ZIndex = 200
    })

    local frame = Library:Create("Frame", {
        Size = UDim2.new(0, 300, 0, 350),
        Position = UDim2.new(0.5, -150, 0.5, -175),
        BackgroundColor3 = Library.Theme.Background,
        BorderSizePixel = 0,
        Parent = overlay,
        ZIndex = 201
    })

    local titleBar = Library:Create("Frame", {
        Size = UDim2.new(1,0,0,30),
        BackgroundColor3 = Library.Theme.Topbar,
        BorderSizePixel = 0,
        Parent = frame,
        ZIndex = 202
    })

    local titleLabel = Library:Create("TextLabel", {
        Size = UDim2.new(1,-30,1,0),
        Position = UDim2.new(0,10,0,0),
        BackgroundTransparency = 1,
        Text = self.Title,
        TextColor3 = Library.Theme.Text,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = titleBar,
        ZIndex = 203
    })

    local closeBtn = Library:Create("TextButton", {
        Size = UDim2.new(0,30,1,0),
        Position = UDim2.new(1,-30,0,0),
        BackgroundColor3 = Library.Theme.Danger,
        BorderSizePixel = 0,
        Text = "X",
        TextColor3 = Library.Theme.Text,
        Font = Enum.Font.Gotham,
        TextSize = 16,
        Parent = titleBar,
        ZIndex = 203
    })

    -- Color preview
    local preview = Library:Create("Frame", {
        Size = UDim2.new(0, 50, 0, 50),
        Position = UDim2.new(0, 10, 0, 40),
        BackgroundColor3 = self.Color,
        BorderSizePixel = 0,
        Parent = frame,
        ZIndex = 203
    })

    -- HSV sliders
    local hVal, sVal, vVal = self:RGBToHSV(self.Color)

    local function createSlider(label, min, max, default, callback)
        local container = Library:Create("Frame", {
            Size = UDim2.new(1, -20, 0, 40),
            Position = UDim2.new(0, 10, 0, 100 + (#label * 45)),
            BackgroundTransparency = 1,
            Parent = frame,
            ZIndex = 203
        })

        local lbl = Library:Create("TextLabel", {
            Size = UDim2.new(0, 30, 0, 20),
            BackgroundTransparency = 1,
            Text = label,
            TextColor3 = Library.Theme.Text,
            Font = Enum.Font.Gotham,
            TextSize = 14,
            Parent = container
        })

        local valueLbl = Library:Create("TextLabel", {
            Size = UDim2.new(0, 40, 0, 20),
            Position = UDim2.new(1, -40, 0, 0),
            BackgroundTransparency = 1,
            Text = tostring(default),
            TextColor3 = Library.Theme.Text,
            Font = Enum.Font.Gotham,
            TextSize = 14,
            TextXAlignment = Enum.TextXAlignment.Right,
            Parent = container
        })

        local bg = Library:Create("Frame", {
            Size = UDim2.new(1, -80, 0, 10),
            Position = UDim2.new(0, 30, 0, 20),
            BackgroundColor3 = Library.Theme.Element,
            BorderSizePixel = 0,
            Parent = container
        })

        local fill = Library:Create("Frame", {
            Size = UDim2.new((default-min)/(max-min), 0, 1, 0),
            BackgroundColor3 = Library.Theme.Accent,
            BorderSizePixel = 0,
            Parent = bg
        })

        local dragging = false
        bg.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
            end
        end)
        bg.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)
        UserInputService.InputChanged:Connect(function(input)
            if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                local mousePos = UserInputService:GetMouseLocation()
                local absPos = bg.AbsolutePosition
                local absSize = bg.AbsoluteSize.X
                local rel = math.clamp((mousePos.X - absPos.X) / absSize, 0, 1)
                local val = min + (max - min) * rel
                val = Library:Round(val, 0)
                fill.Size = UDim2.new(rel, 0, 1, 0)
                valueLbl.Text = tostring(val)
                callback(val)
            end
        end)

        return container
    end

    -- Sliders for H, S, V
    createSlider("H", 0, 360, hVal, function(val)
        hVal = val
        self.Color = self:HSVToRGB(hVal, sVal, vVal)
        preview.BackgroundColor3 = self.Color
        if self.Callback then self.Callback(self.Color) end
    end)

    createSlider("S", 0, 100, sVal, function(val)
        sVal = val
        self.Color = self:HSVToRGB(hVal, sVal, vVal)
        preview.BackgroundColor3 = self.Color
        if self.Callback then self.Callback(self.Color) end
    end)

    createSlider("V", 0, 100, vVal, function(val)
        vVal = val
        self.Color = self:HSVToRGB(hVal, sVal, vVal)
        preview.BackgroundColor3 = self.Color
        if self.Callback then self.Callback(self.Color) end
    end)

    closeBtn.MouseButton1Click:Connect(function()
        overlay:Destroy()
        self.Open = false
    end)
end

-- ------------------------------------------------------------------
-- Element base (every UI element will inherit from this)
-- ------------------------------------------------------------------
local Element = {}
Element.__index = Element

function Element:SetVisible(visible)
    if self.Container then
        self.Container.Visible = visible
    end
end

function Element:SetValue(value)
    self.Value = value
    Library.Flags[self.Flag] = value
    if self.Callback then
        pcall(self.Callback, value)
    end
end

-- ------------------------------------------------------------------
-- Toggle
-- ------------------------------------------------------------------
local Toggle = setmetatable({}, {__index = Element})
Toggle.__index = Toggle

function Toggle.new(parent, settings)
    local self = setmetatable({}, Toggle)
    self.Type = "Toggle"
    self.Flag = settings.Flag or ("toggle_"..tostring(math.random(1,999999)))
    self.Text = settings.Text or "Toggle"
    self.Default = settings.Default or false
    self.Callback = settings.Callback or function() end
    self.Parent = parent
    self.Dependencies = {}
    self.KeyPicker = nil
    self.Container = Library:Create("Frame", {
        Size = UDim2.new(1, -10, 0, 25),
        BackgroundTransparency = 1,
        Parent = parent.Content
    })

    local layout = Library:Create("UIListLayout", {
        FillDirection = Enum.FillDirection.Horizontal,
        HorizontalAlignment = Enum.HorizontalAlignment.Left,
        VerticalAlignment = Enum.VerticalAlignment.Center,
        Padding = UDim.new(0, 5),
        Parent = self.Container
    })

    local toggleBtn = Library:Create("TextButton", {
        Size = UDim2.new(0, 20, 0, 20),
        BackgroundColor3 = Library.Theme.Element,
        BorderSizePixel = 0,
        AutoButtonColor = false,
        Text = "",
        Parent = self.Container
    })

    self.Check = Library:Create("Frame", {
        Size = UDim2.new(1, -4, 1, -4),
        Position = UDim2.new(0, 2, 0, 2),
        BackgroundColor3 = Library.Theme.Accent,
        BorderSizePixel = 0,
        Visible = self.Default,
        Parent = toggleBtn
    })

    local label = Library:Create("TextLabel", {
        Size = UDim2.new(0, 150, 0, 20),
        BackgroundTransparency = 1,
        Text = self.Text,
        TextColor3 = Library.Theme.Text,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = self.Container
    })

    self.Value = self.Default
    Library.Flags[self.Flag] = self.Value

    toggleBtn.MouseButton1Click:Connect(function()
        self:SetValue(not self.Value)
        self.Check.Visible = self.Value
    end)

    -- KeyPicker placeholder
    self.KeyPickerContainer = Library:Create("Frame", {
        Size = UDim2.new(0, 60, 0, 20),
        BackgroundTransparency = 1,
        Parent = self.Container
    })

    return self
end

function Toggle:SetValue(value)
    self.Value = value
    self.Check.Visible = value
    Library.Flags[self.Flag] = value
    pcall(self.Callback, value)
    -- Update dependencies
    for _, dep in ipairs(self.Dependencies) do
        dep:UpdateVisibility(value)
    end
end

function Toggle:AddKeyPicker(settings)
    settings = settings or {}
    local picker = KeyPicker.new(self.KeyPickerContainer, {
        Text = settings.Text or "",
        Mode = settings.Mode or "Toggle",
        Callback = function(key)
            -- When key pressed, toggle
            if settings.Mode == "Toggle" then
                self:SetValue(not self.Value)
            elseif settings.Mode == "Hold" then
                -- Not implemented here
            end
        end
    })
    self.KeyPicker = picker
    return picker
end

function Toggle:AddColorPicker(settings)
    -- Add a color picker button next to toggle
    local btn = Library:Create("TextButton", {
        Size = UDim2.new(0, 20, 0, 20),
        BackgroundColor3 = settings.Default or Color3.new(1,1,1),
        BorderSizePixel = 0,
        Text = "",
        Parent = self.Container
    })
    btn.MouseButton1Click:Connect(function()
        local picker = ColorPicker.new(settings.Title or "Color", settings.Default, function(color)
            btn.BackgroundColor3 = color
            if settings.Callback then settings.Callback(color) end
        end)
        picker:Open()
    end)
    return btn
end

-- ------------------------------------------------------------------
-- Slider
-- ------------------------------------------------------------------
local Slider = setmetatable({}, {__index = Element})
Slider.__index = Slider

function Slider.new(parent, settings)
    local self = setmetatable({}, Slider)
    self.Flag = settings.Flag or ("slider_"..tostring(math.random(1,999999)))
    self.Text = settings.Text or "Slider"
    self.Min = settings.Min or 0
    self.Max = settings.Max or 100
    self.Default = settings.Default or 50
    self.Rounding = settings.Rounding or 0
    self.Suffix = settings.Suffix or ""
    self.Callback = settings.Callback or function() end
    self.Parent = parent
    self.Container = Library:Create("Frame", {
        Size = UDim2.new(1, -10, 0, 40),
        BackgroundTransparency = 1,
        Parent = parent.Content
    })

    local label = Library:Create("TextLabel", {
        Size = UDim2.new(0, 150, 0, 20),
        BackgroundTransparency = 1,
        Text = self.Text,
        TextColor3 = Library.Theme.Text,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = self.Container
    })

    self.ValueDisplay = Library:Create("TextLabel", {
        Size = UDim2.new(0, 50, 0, 20),
        Position = UDim2.new(1, -50, 0, 0),
        BackgroundTransparency = 1,
        Text = tostring(self.Default)..self.Suffix,
        TextColor3 = Library.Theme.Text,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Right,
        Parent = self.Container
    })

    local sliderBg = Library:Create("Frame", {
        Size = UDim2.new(1, 0, 0, 10),
        Position = UDim2.new(0, 0, 0, 25),
        BackgroundColor3 = Library.Theme.Element,
        BorderSizePixel = 0,
        Parent = self.Container
    })

    self.SliderFill = Library:Create("Frame", {
        Size = UDim2.new((self.Default-self.Min)/(self.Max-self.Min), 0, 1, 0),
        BackgroundColor3 = Library.Theme.Accent,
        BorderSizePixel = 0,
        Parent = sliderBg
    })

    self.Value = self.Default
    Library.Flags[self.Flag] = self.Value

    local dragging = false
    sliderBg.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
        end
    end)
    sliderBg.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local mousePos = UserInputService:GetMouseLocation()
            local absPos = sliderBg.AbsolutePosition
            local absSize = sliderBg.AbsoluteSize.X
            local relative = math.clamp((mousePos.X - absPos.X) / absSize, 0, 1)
            local value = self.Min + (self.Max - self.Min) * relative
            if self.Rounding then
                value = Library:Round(value, self.Rounding)
            end
            self:SetValue(value)
        end
    end)

    return self
end

function Slider:SetValue(value)
    value = math.clamp(value, self.Min, self.Max)
    self.Value = value
    self.ValueDisplay.Text = tostring(value)..self.Suffix
    self.SliderFill.Size = UDim2.new((value-self.Min)/(self.Max-self.Min), 0, 1, 0)
    Library.Flags[self.Flag] = value
    pcall(self.Callback, value)
end

-- ------------------------------------------------------------------
-- Dropdown
-- ------------------------------------------------------------------
local Dropdown = setmetatable({}, {__index = Element})
Dropdown.__index = Dropdown

function Dropdown.new(parent, settings)
    local self = setmetatable({}, Dropdown)
    self.Flag = settings.Flag or ("dropdown_"..tostring(math.random(1,999999)))
    self.Text = settings.Text or "Dropdown"
    self.Values = settings.Values or {}
    self.Default = settings.Default or (self.Values[1] or "")
    self.Multi = settings.Multi or false
    self.Callback = settings.Callback or function() end
    self.Parent = parent
    self.Container = Library:Create("Frame", {
        Size = UDim2.new(1, -10, 0, 30),
        BackgroundTransparency = 1,
        Parent = parent.Content
    })

    local label = Library:Create("TextLabel", {
        Size = UDim2.new(0, 150, 1, 0),
        BackgroundTransparency = 1,
        Text = self.Text,
        TextColor3 = Library.Theme.Text,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = self.Container
    })

    self.DropBtn = Library:Create("TextButton", {
        Size = UDim2.new(0, 120, 0, 20),
        Position = UDim2.new(1, -120, 0.5, -10),
        BackgroundColor3 = Library.Theme.Element,
        BorderSizePixel = 0,
        Text = self.Multi and "Select" or tostring(self.Default),
        TextColor3 = Library.Theme.Text,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        Parent = self.Container
    })

    self.DropdownFrame = Library:Create("Frame", {
        Size = UDim2.new(0, 120, 0, 0),
        Position = UDim2.new(1, -120, 0, 20),
        BackgroundColor3 = Library.Theme.Background,
        BorderSizePixel = 0,
        ClipsDescendants = true,
        Visible = false,
        Parent = self.Container,
        ZIndex = 10
    })

    local list = Library:Create("UIListLayout", {
        FillDirection = Enum.FillDirection.Vertical,
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        VerticalAlignment = Enum.VerticalAlignment.Top,
        Padding = UDim.new(0, 2),
        Parent = self.DropdownFrame
    })

    self.Value = self.Multi and {} or self.Default
    Library.Flags[self.Flag] = self.Value

    self.DropBtn.MouseButton1Click:Connect(function()
        self.DropdownFrame.Visible = not self.DropdownFrame.Visible
        if self.DropdownFrame.Visible then
            self:RefreshDropdown()
        end
    end)

    return self
end

function Dropdown:RefreshDropdown()
    -- Clear existing buttons
    for _, child in ipairs(self.DropdownFrame:GetChildren()) do
        if child:IsA("TextButton") then child:Destroy() end
    end
    -- Create buttons for each value
    for _, val in ipairs(self.Values) do
        local btn = Library:Create("TextButton", {
            Size = UDim2.new(1, 0, 0, 20),
            BackgroundColor3 = Library.Theme.Element,
            BorderSizePixel = 0,
            Text = tostring(val),
            TextColor3 = Library.Theme.Text,
            Font = Enum.Font.Gotham,
            TextSize = 14,
            Parent = self.DropdownFrame
        })
        btn.MouseButton1Click:Connect(function()
            if self.Multi then
                -- Toggle in table
                if self.Value[val] then
                    self.Value[val] = nil
                else
                    self.Value[val] = true
                end
                self.DropBtn.Text = "Selected"
            else
                self.Value = val
                self.DropBtn.Text = tostring(val)
                self.DropdownFrame.Visible = false
            end
            Library.Flags[self.Flag] = self.Value
            pcall(self.Callback, self.Value)
        end)
    end
    -- Adjust frame size
    self.DropdownFrame.Size = UDim2.new(0,120,0, math.min(#self.Values * 22, 150))
end

-- ------------------------------------------------------------------
-- KeyPicker
-- ------------------------------------------------------------------
local KeyPicker = setmetatable({}, {__index = Element})
KeyPicker.__index = KeyPicker

function KeyPicker.new(parent, settings)
    local self = setmetatable({}, KeyPicker)
    self.Flag = settings.Flag or ("key_"..tostring(math.random(1,999999)))
    self.Text = settings.Text or ""
    self.Mode = settings.Mode or "Toggle"  -- Toggle, Hold, Always
    self.Default = settings.Default or nil
    self.Callback = settings.Callback or function() end
    self.Parent = parent
    self.Key = self.Default
    self.Active = false
    Library.Flags[self.Flag] = self.Key

    self.Button = Library:Create("TextButton", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundColor3 = Library.Theme.Element,
        BorderSizePixel = 0,
        Text = self.Key and self.Key.Name or "None",
        TextColor3 = Library.Theme.Text,
        Font = Enum.Font.Gotham,
        TextSize = 12,
        Parent = parent
    })

    self.Button.MouseButton1Click:Connect(function()
        self.Button.Text = "..."
        KeyRecorder.new(function(key)
            self.Key = key
            self.Button.Text = (key == Enum.KeyCode.Unknown or not key) and "None" or key.Name
            Library.Flags[self.Flag] = key
            pcall(self.Callback, key)
        end)
    end)

    return self
end

-- ------------------------------------------------------------------
-- Input
-- ------------------------------------------------------------------
local Input = setmetatable({}, {__index = Element})
Input.__index = Input

function Input.new(parent, settings)
    local self = setmetatable({}, Input)
    self.Flag = settings.Flag or ("input_"..tostring(math.random(1,999999)))
    self.Text = settings.Text or "Input"
    self.Placeholder = settings.Placeholder or ""
    self.Numeric = settings.Numeric or false
    self.Callback = settings.Callback or function() end
    self.Parent = parent
    self.Container = Library:Create("Frame", {
        Size = UDim2.new(1, -10, 0, 30),
        BackgroundTransparency = 1,
        Parent = parent.Content
    })

    local label = Library:Create("TextLabel", {
        Size = UDim2.new(0, 150, 1, 0),
        BackgroundTransparency = 1,
        Text = self.Text,
        TextColor3 = Library.Theme.Text,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = self.Container
    })

    self.Box = Library:Create("TextBox", {
        Size = UDim2.new(0, 120, 0, 20),
        Position = UDim2.new(1, -120, 0.5, -10),
        BackgroundColor3 = Library.Theme.Element,
        BorderSizePixel = 0,
        Text = "",
        PlaceholderText = self.Placeholder,
        TextColor3 = Library.Theme.Text,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        ClearTextOnFocus = false,
        Parent = self.Container
    })

    self.Value = ""
    Library.Flags[self.Flag] = self.Value

    self.Box.FocusLost:Connect(function(enterPressed)
        local text = self.Box.Text
        if self.Numeric then
            text = tonumber(text) or 0
        end
        self.Value = text
        Library.Flags[self.Flag] = text
        pcall(self.Callback, text)
    end)

    return self
end

-- ------------------------------------------------------------------
-- Button
-- ------------------------------------------------------------------
local Button = setmetatable({}, {__index = Element})
Button.__index = Button

function Button.new(parent, settings)
    local self = setmetatable({}, Button)
    self.Text = settings.Text or "Button"
    self.Func = settings.Func or function() end
    self.Container = Library:Create("Frame", {
        Size = UDim2.new(1, -10, 0, 25),
        BackgroundTransparency = 1,
        Parent = parent.Content
    })

    self.Btn = Library:Create("TextButton", {
        Size = UDim2.new(0, 100, 0, 20),
        Position = UDim2.new(0.5, -50, 0, 2.5),
        BackgroundColor3 = Library.Theme.Element,
        BorderSizePixel = 0,
        Text = self.Text,
        TextColor3 = Library.Theme.Text,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        Parent = self.Container
    })

    self.Btn.MouseButton1Click:Connect(function()
        pcall(self.Func)
    end)

    return self
end

-- ------------------------------------------------------------------
-- Label
-- ------------------------------------------------------------------
local Label = setmetatable({}, {__index = Element})
Label.__index = Label

function Label.new(parent, settings)
    local self = setmetatable({}, Label)
    self.Text = settings.Text or ""
    self.Container = Library:Create("Frame", {
        Size = UDim2.new(1, -10, 0, 20),
        BackgroundTransparency = 1,
        Parent = parent.Content
    })

    self.Label = Library:Create("TextLabel", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Text = self.Text,
        TextColor3 = Library.Theme.Text,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = self.Container
    })

    return self
end

function Label:SetText(text)
    self.Label.Text = text
end

-- ------------------------------------------------------------------
-- Divider
-- ------------------------------------------------------------------
local Divider = setmetatable({}, {__index = Element})
Divider.__index = Divider

function Divider.new(parent, settings)
    local self = setmetatable({}, Divider)
    self.Text = settings.Text or ""
    self.Container = Library:Create("Frame", {
        Size = UDim2.new(1, -10, 0, 20),
        BackgroundTransparency = 1,
        Parent = parent.Content
    })

    local line = Library:Create("Frame", {
        Size = UDim2.new(1, 0, 0, 1),
        Position = UDim2.new(0, 0, 0.5, 0),
        BackgroundColor3 = Library.Theme.Element,
        BorderSizePixel = 0,
        Parent = self.Container
    })

    if self.Text ~= "" then
        local label = Library:Create("TextLabel", {
            Size = UDim2.new(0, #self.Text * 8, 1, 0),
            Position = UDim2.new(0.5, - (#self.Text * 4), 0, 0),
            BackgroundTransparency = 1,
            Text = self.Text,
            TextColor3 = Library.Theme.Text,
            Font = Enum.Font.Gotham,
            TextSize = 12,
            Parent = self.Container
        })
    end

    return self
end

-- ------------------------------------------------------------------
-- Groupbox (base)
-- ------------------------------------------------------------------
local Groupbox = {}
Groupbox.__index = Groupbox

function Groupbox.new(parent, name, side)
    local self = setmetatable({}, Groupbox)
    self.Name = name
    self.Side = side or "left"
    self.Elements = {}
    self.Dependencies = {}

    self.Frame = Library:Create("Frame", {
        Size = (side == "full") and UDim2.new(1, -10, 0, 200) or UDim2.new(0.5, -10, 0, 200),
        BackgroundColor3 = Library.Theme.Background,
        BorderSizePixel = 0,
        Parent = parent.Page
    })

    local title = Library:Create("TextLabel", {
        Size = UDim2.new(1, 0, 0, 20),
        BackgroundColor3 = Library.Theme.Topbar,
        BorderSizePixel = 0,
        Text = name,
        TextColor3 = Library.Theme.Text,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        Parent = self.Frame
    })

    self.Content = Library:Create("ScrollingFrame", {
        Size = UDim2.new(1, 0, 1, -20),
        Position = UDim2.new(0, 0, 0, 20),
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        ScrollBarThickness = 4,
        CanvasSize = UDim2.new(0,0,0,0),
        AutomaticCanvasSize = Enum.AutomaticSize.Y,
        Parent = self.Frame
    })

    local layout = Library:Create("UIListLayout", {
        FillDirection = Enum.FillDirection.Vertical,
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        VerticalAlignment = Enum.VerticalAlignment.Top,
        Padding = UDim.new(0, 5),
        Parent = self.Content
    })

    layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        self.Content.CanvasSize = UDim2.new(0,0,0, layout.AbsoluteContentSize.Y + 10)
    end)

    return self
end

function Groupbox:AddToggle(settings)
    local toggle = Toggle.new(self, settings)
    table.insert(self.Elements, toggle)
    return toggle
end

function Groupbox:AddSlider(settings)
    local slider = Slider.new(self, settings)
    table.insert(self.Elements, slider)
    return slider
end

function Groupbox:AddDropdown(settings)
    local dropdown = Dropdown.new(self, settings)
    table.insert(self.Elements, dropdown)
    return dropdown
end

function Groupbox:AddInput(settings)
    local input = Input.new(self, settings)
    table.insert(self.Elements, input)
    return input
end

function Groupbox:AddButton(settings)
    local btn = Button.new(self, settings)
    table.insert(self.Elements, btn)
    return btn
end

function Groupbox:AddLabel(settings)
    local label = Label.new(self, settings)
    table.insert(self.Elements, label)
    return label
end

function Groupbox:AddDivider(settings)
    local div = Divider.new(self, settings)
    table.insert(self.Elements, div)
    return div
end

function Groupbox:AddDependencyBox()
    -- Creates a container that can be shown/hidden based on dependencies
    local depBox = Library:Create("Frame", {
        Size = UDim2.new(1, -10, 0, 0),
        BackgroundTransparency = 1,
        Parent = self.Content,
        Visible = true
    })
    local layout = Library:Create("UIListLayout", {
        FillDirection = Enum.FillDirection.Vertical,
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        VerticalAlignment = Enum.VerticalAlignment.Top,
        Padding = UDim.new(0, 5),
        Parent = depBox
    })
    local box = {
        Frame = depBox,
        Content = depBox,
        Elements = {},
        AddToggle = function(_, s) local t = Toggle.new({Content=depBox}, s); table.insert(box.Elements, t); return t end,
        AddSlider = function(_, s) local sl = Slider.new({Content=depBox}, s); table.insert(box.Elements, sl); return sl end,
        AddDropdown = function(_, s) local dd = Dropdown.new({Content=depBox}, s); table.insert(box.Elements, dd); return dd end,
        AddInput = function(_, s) local inp = Input.new({Content=depBox}, s); table.insert(box.Elements, inp); return inp end,
        AddButton = function(_, s) local btn = Button.new({Content=depBox}, s); table.insert(box.Elements, btn); return btn end,
        AddLabel = function(_, s) local lbl = Label.new({Content=depBox}, s); table.insert(box.Elements, lbl); return lbl end,
        AddDivider = function(_, s) local div = Divider.new({Content=depBox}, s); table.insert(box.Elements, div); return div end,
    }
    return box
end

-- ------------------------------------------------------------------
-- Tab
-- ------------------------------------------------------------------
local Tab = {}
Tab.__index = Tab

function Tab.new(window, name)
    local self = setmetatable({}, Tab)
    self.Name = name
    self.Window = window
    self.Groupboxes = {}

    self.Button = Library:Create("TextButton", {
        Size = UDim2.new(0, 80, 0, 25),
        BackgroundColor3 = Library.Theme.Element,
        BorderSizePixel = 0,
        Text = name,
        TextColor3 = Library.Theme.Text,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        Parent = window.TabsBar
    })

    self.Page = Library:Create("ScrollingFrame", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        ScrollBarThickness = 6,
        Visible = false,
        Parent = window.Pages,
        CanvasSize = UDim2.new(0,0,0,0),
        AutomaticCanvasSize = Enum.AutomaticSize.Y
    })

    self.Button.MouseButton1Click:Connect(function()
        window:SelectTab(self)
    end)

    return self
end

function Tab:AddLeftGroupbox(name)
    local gb = Groupbox.new(self, name, "left")
    table.insert(self.Groupboxes, gb)
    return gb
end

function Tab:AddRightGroupbox(name)
    local gb = Groupbox.new(self, name, "right")
    table.insert(self.Groupboxes, gb)
    return gb
end

function Tab:AddLeftTabbox()
    -- Creates a frame that holds two tabbed groupboxes side by side (simplified)
    local container = Library:Create("Frame", {
        Size = UDim2.new(0.5, -10, 0, 200),
        BackgroundTransparency = 1,
        Parent = self.Page
    })
    local tabbar = Library:Create("Frame", {
        Size = UDim2.new(1,0,0,25),
        BackgroundColor3 = Library.Theme.Topbar,
        Parent = container
    })
    local pages = Library:Create("Frame", {
        Size = UDim2.new(1,0,1,-25),
        Position = UDim2.new(0,0,0,25),
        BackgroundTransparency = 1,
        Parent = container
    })
    local tabs = {}
    local activePage = nil
    local function addTab(name)
        local btn = Library:Create("TextButton", {
            Size = UDim2.new(0,60,1,0),
            BackgroundColor3 = Library.Theme.Element,
            Text = name,
            TextColor3 = Library.Theme.Text,
            Font = Enum.Font.Gotham,
            TextSize = 14,
            Parent = tabbar
        })
        local page = Library:Create("ScrollingFrame", {
            Size = UDim2.new(1,0,1,0),
            BackgroundTransparency = 1,
            Visible = false,
            Parent = pages,
            CanvasSize = UDim2.new(0,0,0,0),
            AutomaticCanvasSize = Enum.AutomaticSize.Y
        })
        btn.MouseButton1Click:Connect(function()
            if activePage then activePage.Visible = false end
            page.Visible = true
            activePage = page
        end)
        return page
    end
    return {AddTab = addTab}
end

-- ------------------------------------------------------------------
-- Window
-- ------------------------------------------------------------------
local Window = {}
Window.__index = Window

function Window.new(options)
    local self = setmetatable({}, Window)
    self.Title = options.Title or "Library"
    self.Size = options.Size or UDim2.new(0,600,0,400)
    self.Position = options.Center and UDim2.new(0.5,-300,0.5,-200) or options.Position or UDim2.new(0,100,0,100)
    self.Tabs = {}
    self.ActiveTab = nil

    self.GUI = Library:Create("ScreenGui", {
        Name = "CustomUILib",
        Parent = LocalPlayer:WaitForChild("PlayerGui"),
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    })

    self.Main = Library:Create("Frame", {
        Size = self.Size,
        Position = self.Position,
        BackgroundColor3 = Library.Theme.Background,
        BorderSizePixel = 0,
        Active = true,
        Parent = self.GUI
    })

    -- Make draggable
    local dragging = false, dragInput, dragStart, startPos
    self.Main.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = self.Main.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    self.Main.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
            local delta = input.Position - dragStart
            self.Main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)

    self.Topbar = Library:Create("Frame", {
        Size = UDim2.new(1,0,0,30),
        BackgroundColor3 = Library.Theme.Topbar,
        BorderSizePixel = 0,
        Parent = self.Main
    })

    self.TitleLabel = Library:Create("TextLabel", {
        Size = UDim2.new(1,-30,1,0),
        Position = UDim2.new(0,10,0,0),
        BackgroundTransparency = 1,
        Text = self.Title,
        TextColor3 = Library.Theme.Text,
        Font = Enum.Font.Gotham,
        TextSize = 16,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = self.Topbar
    })

    self.TabsBar = Library:Create("Frame", {
        Size = UDim2.new(1,0,0,30),
        Position = UDim2.new(0,0,0,30),
        BackgroundColor3 = Library.Theme.Element,
        BorderSizePixel = 0,
        Parent = self.Main
    })

    self.Pages = Library:Create("Frame", {
        Size = UDim2.new(1,0,1,-60),
        Position = UDim2.new(0,0,0,60),
        BackgroundTransparency = 1,
        Parent = self.Main
    })

    Library.CurrentMenu = self
    return self
end

function Window:AddTab(name)
    local tab = Tab.new(self, name)
    table.insert(self.Tabs, tab)
    if #self.Tabs == 1 then
        self:SelectTab(tab)
    end
    return tab
end

function Window:SelectTab(tab)
    if self.ActiveTab then
        self.ActiveTab.Page.Visible = false
        self.ActiveTab.Button.BackgroundColor3 = Library.Theme.Element
    end
    tab.Page.Visible = true
    tab.Button.BackgroundColor3 = Library.Theme.Accent
    self.ActiveTab = tab
end

-- ------------------------------------------------------------------
-- Save Manager (simple)
-- ------------------------------------------------------------------
local SaveManager = {}
SaveManager.__index = SaveManager

function SaveManager:SetLibrary(lib)
    self.Library = lib
end

function SaveManager:SetFolder(folder)
    self.Folder = folder
end

function SaveManager:SaveConfig(name)
    local data = {}
    for flag, value in pairs(Library.Flags) do
        data[flag] = value
    end
    local json = HttpService:JSONEncode(data)
    if writefile then
        writefile(self.Folder .. "/" .. name .. ".json", json)
    else
        Library:Notify("writefile not supported", 2)
    end
end

function SaveManager:LoadConfig(name)
    local file = self.Folder .. "/" .. name .. ".json"
    if isfile and isfile(file) then
        local json = readfile(file)
        local data = HttpService:JSONDecode(json)
        for flag, value in pairs(data) do
            Library.Flags[flag] = value
            -- Find element and update UI (not implemented here)
        end
        Library:Notify("Config loaded", 2)
    else
        Library:Notify("Config not found", 2)
    end
end

-- ------------------------------------------------------------------
-- Theme Manager (minimal)
-- ------------------------------------------------------------------
local ThemeManager = {}
ThemeManager.__index = ThemeManager

function ThemeManager:SetLibrary(lib)
    self.Library = lib
end

function ThemeManager:SetFolder(folder)
    self.Folder = folder
end

function ThemeManager:ApplyToTab(tab)
    -- Add theme controls to the tab
    local group = tab:AddLeftGroupbox("Theme")
    group:AddButton({Text = "Light Theme", Func = function()
        Library.Theme.Background = Color3.fromRGB(240,240,240)
        Library.Theme.Topbar = Color3.fromRGB(220,220,220)
        Library.Theme.Element = Color3.fromRGB(200,200,200)
        Library.Theme.Text = Color3.new(0,0,0)
        -- In a full implementation, refresh UI colors
    end})
    group:AddButton({Text = "Dark Theme", Func = function()
        Library.Theme.Background = Color3.fromRGB(25,25,25)
        Library.Theme.Topbar = Color3.fromRGB(20,20,20)
        Library.Theme.Element = Color3.fromRGB(45,45,45)
        Library.Theme.Text = Color3.new(1,1,1)
    end})
end

-- ------------------------------------------------------------------
-- Exports
-- ------------------------------------------------------------------
Library.CreateWindow = Window.new
Library.Toggle = Toggle
Library.Slider = Slider
Library.Dropdown = Dropdown
Library.KeyPicker = KeyPicker
Library.Input = Input
Library.Button = Button
Library.Label = Label
Library.Divider = Divider
Library.SaveManager = SaveManager
Library.ThemeManager = ThemeManager
Library.Notify = Library.Notify -- already defined

-- ------------------------------------------------------------------
-- Example Usage (uncomment to test)
-- ------------------------------------------------------------------
--[[
local Window = Library:CreateWindow({
    Title = "My Awesome Script",
    Center = true,
    Size = UDim2.new(0, 700, 0, 500)
})

local Tabs = {
    Main = Window:AddTab("Main"),
    Combat = Window:AddTab("Combat"),
    Visuals = Window:AddTab("Visuals"),
    Settings = Window:AddTab("Settings")
}

-- Main tab
local left = Tabs.Main:AddLeftGroupbox("Main Features")
local right = Tabs.Main:AddRightGroupbox("Extra")

left:AddToggle({
    Flag = "toggle1",
    Text = "Enable Feature",
    Default = true,
    Callback = function(v) print("Toggle:", v) end
}):AddKeyPicker({Text = "F"})

left:AddSlider({
    Flag = "slider1",
    Text = "Speed",
    Default = 50,
    Min = 0,
    Max = 100,
    Rounding = 0,
    Suffix = "%",
    Callback = function(v) print("Speed:", v) end
})

left:AddDropdown({
    Flag = "dropdown1",
    Text = "Mode",
    Values = {"Easy", "Medium", "Hard"},
    Default = "Medium",
    Callback = function(v) print("Mode:", v) end
})

left:AddInput({
    Flag = "input1",
    Text = "Name",
    Placeholder = "Enter name",
    Callback = function(v) print("Name:", v) end
})

left:AddButton({
    Text = "Click Me",
    Func = function() print("Button clicked") end
})

left:AddLabel({Text = "This is a label"})
left:AddDivider({Text = "Section"})

right:AddToggle({
    Flag = "toggle2",
    Text = "Another Toggle",
    Default = false,
    Callback = function(v) print("Toggle2:", v) end
})

-- Dependency example
local depToggle = left:AddToggle({
    Flag = "depToggle",
    Text = "Show Extra Options",
    Default = false
})

local depBox = left:AddDependencyBox()
depBox:AddToggle({Flag = "subToggle", Text = "Sub Option", Default = false})
depBox:AddSlider({Flag = "subSlider", Text = "Sub Slider", Default = 10, Min=0, Max=100})

depToggle:SetValue(false)
depToggle.Callback = function(val)
    depBox.Frame.Visible = val
end

-- Settings tab for theme/save
local themeGroup = Tabs.Settings:AddLeftGroupbox("Theme")
themeGroup:AddButton({Text = "Apply Dark", Func = function()
    Library.Theme.Background = Color3.fromRGB(25,25,25)
    Library.Theme.Topbar = Color3.fromRGB(20,20,20)
    Library.Theme.Element = Color3.fromRGB(45,45,45)
    Library.Theme.Text = Color3.new(1,1,1)
end})
themeGroup:AddButton({Text = "Apply Light", Func = function()
    Library.Theme.Background = Color3.fromRGB(240,240,240)
    Library.Theme.Topbar = Color3.fromRGB(220,220,220)
    Library.Theme.Element = Color3.fromRGB(200,200,200)
    Library.Theme.Text = Color3.new(0,0,0)
end})

local saveGroup = Tabs.Settings:AddRightGroupbox("Save/Load")
saveGroup:AddButton({Text = "Save Config", Func = function()
    Library.SaveManager:SaveConfig("config1")
end})
saveGroup:AddButton({Text = "Load Config", Func = function()
    Library.SaveManager:LoadConfig("config1")
end})

-- Test notification
task.wait(1)
Library:Notify("Welcome to the script!", 3)
--]]

return Library
