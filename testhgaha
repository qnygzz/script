--[[
    Linoria-style UI Library (Complete)
    Features:
    - Window, Tabs, Groupboxes (left/right/tabbox)
    - Toggle, Slider, Dropdown, KeyPicker, ColorPicker, Input, Button, Label, Divider
    - Dependency boxes, Notifications, Watermark, Keybind list
    - Theme manager, Save manager (needs executor file support)
    Fully self-contained – copy-paste and upload to GitHub.
--]]

-- Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local TextService = game:GetService("TextService")
local CoreGui = gethui and gethui() or cloneref(game:GetService('CoreGui'))
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

local ProtectGui = protectgui or (syn and syn.protect_gui) or (function() end)

local ScreenGui = Instance.new('ScreenGui')
ProtectGui(ScreenGui)
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Global
ScreenGui.Parent = CoreGui
ScreenGui.DisplayOrder = 20
ScreenGui.IgnoreGuiInset = true

local Toggles = {}
local Options = {}
getgenv().Toggles = Toggles
getgenv().Options = Options

local Library = {
    Registry = {},
    RegistryMap = {},
    HudRegistry = {},
    FontColor = Color3.fromRGB(255, 255, 255),
    MainColor = Color3.fromRGB(28, 28, 28),
    BackgroundColor = Color3.fromRGB(20, 20, 20),
    AccentColor = Color3.fromRGB(0, 85, 255),
    OutlineColor = Color3.fromRGB(50, 50, 50),
    RiskColor = Color3.fromRGB(255, 50, 50),
    Black = Color3.new(0, 0, 0),
    Font = Enum.Font.Code,
    OpenedFrames = {},
    DependencyBoxes = {},
    NotificationStyle = {
        Transparency = 0,
        BarSide = "Left",
        Alignment = "Left",
        Y = 0.1,
        X = 0,
    },
    KeypickerListVisible = true,
    KeypickerListMode = "All",
    Signals = {},
    ScreenGui = ScreenGui,
    CurrentRainbowHue = 0,
    CurrentRainbowColor = Color3.new(1,0,0),
    Watermark = nil,
    KeybindList = nil,
}

-- Utility functions
function Library:Create(className, props)
    local obj = Instance.new(className)
    for prop, val in pairs(props) do
        obj[prop] = val
    end
    return obj
end

function Library:Round(number, precision)
    precision = 10 ^ (precision or 0)
    return math.floor(number * precision + 0.5) / precision
end

function Library:AddConnection(signal, func)
    local conn = signal:Connect(func)
    table.insert(self.Signals, conn)
    return conn
end

function Library:Unload()
    for _, conn in ipairs(self.Signals) do
        pcall(conn.Disconnect, conn)
    end
    if self.ScreenGui then
        pcall(self.ScreenGui.Destroy, self.ScreenGui)
    end
    self.Flags = {}
    self.Tabs = {}
    self.Options = {}
end

function Library:GetTextBounds(Text, Font, Size, Resolution)
    local Bounds = TextService:GetTextSize(Text, Size, Font, Resolution or Vector2.new(1920, 1080))
    return Bounds.X, Bounds.Y
end

function Library:GetDarkerColor(Color)
    local H, S, V = Color3.toHSV(Color)
    return Color3.fromHSV(H, S, V / 1.5)
end
Library.AccentColorDark = Library:GetDarkerColor(Library.AccentColor)

function Library:AddToRegistry(Instance, Properties, IsHud)
    local Idx = #self.Registry + 1
    local Data = {
        Instance = Instance,
        Properties = Properties,
        Idx = Idx,
    }
    table.insert(self.Registry, Data)
    self.RegistryMap[Instance] = Data
    if IsHud then
        table.insert(self.HudRegistry, Data)
    end
end

function Library:RemoveFromRegistry(Instance)
    local Data = self.RegistryMap[Instance]
    if Data then
        for i = #self.Registry, 1, -1 do
            if self.Registry[i] == Data then
                table.remove(self.Registry, i)
            end
        end
        for i = #self.HudRegistry, 1, -1 do
            if self.HudRegistry[i] == Data then
                table.remove(self.HudRegistry, i)
            end
        end
        self.RegistryMap[Instance] = nil
    end
end

function Library:UpdateColorsUsingRegistry()
    for _, Object in ipairs(self.Registry) do
        for Property, ColorIdx in pairs(Object.Properties) do
            if type(ColorIdx) == 'string' then
                Object.Instance[Property] = self[ColorIdx]
            elseif type(ColorIdx) == 'function' then
                Object.Instance[Property] = ColorIdx()
            end
        end
    end
end

function Library:GiveSignal(Signal)
    table.insert(self.Signals, Signal)
end

function Library:OnUnload(Callback)
    self.OnUnload = Callback
end

function Library:SafeCallback(f, ...)
    if not f then return end
    local success, err = pcall(f, ...)
    if not success then
        warn("Callback error:", err)
    end
end

function Library:AttemptSave()
    if self.SaveManager then
        self.SaveManager:Save()
    end
end

function Library:MouseIsOverOpenedFrame()
    for Frame, _ in pairs(self.OpenedFrames) do
        local AbsPos, AbsSize = Frame.AbsolutePosition, Frame.AbsoluteSize
        if Mouse.X >= AbsPos.X and Mouse.X <= AbsPos.X + AbsSize.X
            and Mouse.Y >= AbsPos.Y and Mouse.Y <= AbsPos.Y + AbsSize.Y then
            return true
        end
    end
    return false
end

function Library:IsMouseOverFrame(Frame)
    local AbsPos, AbsSize = Frame.AbsolutePosition, Frame.AbsoluteSize
    return Mouse.X >= AbsPos.X and Mouse.X <= AbsPos.X + AbsSize.X
        and Mouse.Y >= AbsPos.Y and Mouse.Y <= AbsPos.Y + AbsSize.Y
end

function Library:MapValue(Value, MinA, MaxA, MinB, MaxB)
    return (1 - ((Value - MinA) / (MaxA - MinA))) * MinB + ((Value - MinA) / (MaxA - MinA)) * MaxB
end

function Library:MakeDraggable(Instance, Cutoff)
    Instance.Active = true
    Instance.InputBegan:Connect(function(Input)
        if Input.UserInputType == Enum.UserInputType.MouseButton1 then
            local ObjPos = Vector2.new(Mouse.X - Instance.AbsolutePosition.X, Mouse.Y - Instance.AbsolutePosition.Y)
            if ObjPos.Y > (Cutoff or 40) then return end
            while UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton1) do
                Instance.Position = UDim2.new(
                    0, Mouse.X - ObjPos.X + (Instance.Size.X.Offset * Instance.AnchorPoint.X),
                    0, Mouse.Y - ObjPos.Y + (Instance.Size.Y.Offset * Instance.AnchorPoint.Y)
                )
                RunService.RenderStepped:Wait()
            end
        end
    end)
end

-- ------------------------------------------------------------------
-- Notification System
-- ------------------------------------------------------------------
do
    local NotifySettings = {
        BarPosition = {
            ["Top"] = UDim2.new(0, -1, 0, 0),
            ["Left"] = UDim2.new(0, -1, 0, -1),
            ["Right"] = UDim2.new(1, -2, 0, -1),
            ["Bottom"] = UDim2.new(0, -1, 1, -2),
        },
        BarSize = {
            ["Top"] = UDim2.new(1, 3, 0, 2),
            ["Left"] = UDim2.new(0, 3, 1, 2),
            ["Right"] = UDim2.new(0, 3, 1, 2),
            ["Bottom"] = UDim2.new(1, 3, 0, 2),
        },
    }

    local NotificationAreaHolder = Library:Create('Frame', {
        BackgroundTransparency = 1,
        Size = UDim2.new(0, 200, 0, 200),
        ZIndex = 100,
        Parent = ScreenGui,
    })
    Library.NotificationAreaHolder = NotificationAreaHolder

    local NotificationArea = Library:Create('Frame', {
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 0, 0, 1),
        Size = UDim2.new(1, 0, 1, 0),
        ZIndex = 100,
        Parent = NotificationAreaHolder,
    })
    Library.NotificationArea = NotificationArea

    local NotificationListLayout = Library:Create('UIListLayout', {
        Padding = UDim.new(0, 4),
        FillDirection = Enum.FillDirection.Vertical,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Parent = NotificationArea,
    })
    Library.NotificationListLayout = NotificationListLayout

    function Library:Notify(Text, Time)
        Time = Time or 3
        local XSize, YSize = self:GetTextBounds(Text, self.Font, 14)
        YSize = YSize + 7

        local ns = self.NotificationStyle
        local transparency = ns.Transparency or 0
        local main, accent, outline, font = self.MainColor, self.AccentColor, self.OutlineColor, self.FontColor

        local NotifyOuter = self:Create('Frame', {
            BackgroundColor3 = main,
            BorderColor3 = Color3.new(0, 0, 0),
            Size = UDim2.new(0, 0, 0, YSize),
            ClipsDescendants = true,
            Transparency = transparency,
            ZIndex = 100,
        })

        local NotifyInner = self:Create('Frame', {
            BackgroundColor3 = main,
            BorderColor3 = outline,
            BorderMode = Enum.BorderMode.Inset,
            Size = UDim2.new(1, 0, 1, 0),
            Transparency = transparency,
            ZIndex = 101,
            Parent = NotifyOuter,
        })

        local InnerFrame = self:Create('Frame', {
            BackgroundColor3 = Color3.new(1, 1, 1),
            BorderSizePixel = 0,
            Position = UDim2.new(0, 1, 0, 1),
            Size = UDim2.new(1, -2, 1, -2),
            Transparency = transparency,
            ZIndex = 102,
            Parent = NotifyInner,
        })

        local Gradient = self:Create('UIGradient', {
            Color = ColorSequence.new({
                ColorSequenceKeypoint.new(0, self:GetDarkerColor(main)),
                ColorSequenceKeypoint.new(1, main),
            }),
            Rotation = -90,
            Parent = InnerFrame,
        })

        local NotifyLabel = self:CreateLabel({
            Position = UDim2.new(0, 4, 0, 0),
            Size = UDim2.new(1, -4, 1, 0),
            Text = Text,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextSize = 14,
            ZIndex = 103,
            Parent = InnerFrame,
        })
        NotifyLabel.TextColor3 = font

        local LeftColor = self:Create('Frame', {
            BackgroundColor3 = accent,
            BorderSizePixel = 0,
            Size = NotifySettings.BarSize[ns.BarSide] or UDim2.new(0, 3, 1, 2),
            Position = NotifySettings.BarPosition[ns.BarSide] or UDim2.new(0, -1, 0, -1),
            ZIndex = 104,
            Parent = NotifyOuter,
        })

        local align_map = { Left = 0, Center = 0.5, Right = 1 }
        local anchor_x = align_map[ns.Alignment] or 0
        local anchor_y = ((ns.Y or 0) < 0.5) and 0 or 1
        NotificationAreaHolder.AnchorPoint = Vector2.new(anchor_x, anchor_y)
        NotificationAreaHolder.Position = UDim2.new(ns.X or 0, 0, ns.Y or 0, 0)
        NotificationListLayout.VerticalAlignment = (anchor_y == 0) and Enum.VerticalAlignment.Top or Enum.VerticalAlignment.Bottom

        local wrapper = self:Create('Frame', {
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
            Size = UDim2.new(1, 0, 0, YSize),
            ZIndex = NotifyOuter.ZIndex,
            Parent = NotificationArea,
        })

        NotifyOuter.AnchorPoint = Vector2.new(anchor_x, 0)
        NotifyOuter.Position = UDim2.new(anchor_x, 0, 0, 0)
        NotifyOuter.Size = UDim2.new(0, 0, 0, YSize)
        NotifyOuter.Parent = wrapper

        local targetSize = UDim2.new(0, XSize + 8 + 4, 0, YSize)
        TweenService:Create(NotifyOuter, TweenInfo.new(0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), { Size = targetSize }):Play()

        task.spawn(function()
            wait(Time)
            TweenService:Create(NotifyOuter, TweenInfo.new(0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), { Size = UDim2.new(0, 0, 0, YSize) }):Play()
            wait(0.4)
            wrapper:Destroy()
        end)
    end
end

-- ------------------------------------------------------------------
-- Watermark and Keybind List
-- ------------------------------------------------------------------
do
    -- Watermark
    local WatermarkOuter = Library:Create('Frame', {
        BorderColor3 = Color3.new(0, 0, 0),
        Position = UDim2.new(0, 100, 0, -25),
        Size = UDim2.new(0, 213, 0, 20),
        ZIndex = 200,
        Visible = false,
        Parent = ScreenGui,
    })
    Library:MakeDraggable(WatermarkOuter)

    local WatermarkInner = Library:Create('Frame', {
        BackgroundColor3 = Library.MainColor,
        BorderColor3 = Library.AccentColor,
        BorderMode = Enum.BorderMode.Inset,
        Size = UDim2.new(1, 0, 1, 0),
        ZIndex = 201,
        Parent = WatermarkOuter,
    })
    Library:AddToRegistry(WatermarkInner, { BorderColor3 = 'AccentColor' })

    local InnerFrame = Library:Create('Frame', {
        BackgroundColor3 = Color3.new(1, 1, 1),
        BorderSizePixel = 0,
        Position = UDim2.new(0, 1, 0, 1),
        Size = UDim2.new(1, -2, 1, -2),
        ZIndex = 202,
        Parent = WatermarkInner,
    })

    local Gradient = Library:Create('UIGradient', {
        Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Library:GetDarkerColor(Library.MainColor)),
            ColorSequenceKeypoint.new(1, Library.MainColor),
        }),
        Rotation = -90,
        Parent = InnerFrame,
    })
    Library:AddToRegistry(Gradient, {
        Color = function()
            return ColorSequence.new({
                ColorSequenceKeypoint.new(0, Library:GetDarkerColor(Library.MainColor)),
                ColorSequenceKeypoint.new(1, Library.MainColor),
            })
        end
    })

    local WatermarkLabel = Library:CreateLabel({
        Position = UDim2.new(0, 5, 0, 0),
        Size = UDim2.new(1, -4, 1, 0),
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 203,
        Parent = InnerFrame,
    })
    Library.Watermark = WatermarkOuter
    Library.WatermarkText = WatermarkLabel

    function Library:SetWatermarkVisibility(bool)
        Library.Watermark.Visible = bool
    end

    function Library:SetWatermark(text)
        local X, Y = Library:GetTextBounds(text, Library.Font, 14)
        Library.Watermark.Size = UDim2.new(0, X + 15, 0, (Y * 1.5) + 3)
        Library:SetWatermarkVisibility(true)
        Library.WatermarkText.Text = text
    end

    -- Keybind list
    local KeybindOuter = Library:Create('Frame', {
        AnchorPoint = Vector2.new(0, 0.5),
        BorderColor3 = Color3.new(0, 0, 0),
        Position = UDim2.new(0, 10, 0.5, 0),
        Size = UDim2.new(0, 210, 0, 20),
        Visible = false,
        ZIndex = 100,
        Parent = ScreenGui,
    })
    Library:MakeDraggable(KeybindOuter)
    Library.KeybindFrame = KeybindOuter

    local KeybindInner = Library:Create('Frame', {
        BackgroundColor3 = Library.MainColor,
        BorderColor3 = Library.OutlineColor,
        BorderMode = Enum.BorderMode.Inset,
        Size = UDim2.new(1, 0, 1, 0),
        ZIndex = 101,
        Parent = KeybindOuter,
    })
    Library:AddToRegistry(KeybindInner, { BackgroundColor3 = 'MainColor', BorderColor3 = 'OutlineColor' }, true)

    local ColorFrame = Library:Create('Frame', {
        BackgroundColor3 = Library.AccentColor,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 2),
        ZIndex = 102,
        Parent = KeybindInner,
    })
    Library:AddToRegistry(ColorFrame, { BackgroundColor3 = 'AccentColor' }, true)

    local KeybindLabel = Library:CreateLabel({
        Size = UDim2.new(1, 0, 0, 20),
        Position = UDim2.fromOffset(5, 2),
        TextXAlignment = Enum.TextXAlignment.Left,
        Text = 'Keybinds',
        ZIndex = 104,
        Parent = KeybindInner,
    })

    local KeybindContainer = Library:Create('Frame', {
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, -20),
        Position = UDim2.new(0, 0, 0, 20),
        ZIndex = 1,
        Parent = KeybindInner,
    })
    Library.KeybindContainer = KeybindContainer

    Library:Create('UIListLayout', {
        FillDirection = Enum.FillDirection.Vertical,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Parent = KeybindContainer,
    })
    Library:Create('UIPadding', {
        PaddingLeft = UDim.new(0, 5),
        Parent = KeybindContainer,
    })
end

-- ------------------------------------------------------------------
-- Base Addons (KeyPicker, ColorPicker) – attached to Toggle
-- ------------------------------------------------------------------
local BaseAddons = {}

-- ColorPicker (simplified but functional)
function BaseAddons:AddColorPicker(settings)
    local self = self
    local ToggleLabel = self.TextLabel
    assert(settings.Default, 'AddColorPicker: Missing default value.')

    local ColorPicker = {
        Value = settings.Default,
        Transparency = settings.Transparency or 0,
        Type = 'ColorPicker',
        Title = settings.Title or 'Color picker',
        HasTransparency = not not settings.Transparency,
        Callback = settings.Callback or function() end,
        Parent = self,
        Idx = settings.Flag,
    }

    local DisplayFrame = Library:Create('Frame', {
        BackgroundColor3 = ColorPicker.Value,
        BorderColor3 = Library:GetDarkerColor(ColorPicker.Value),
        BorderMode = Enum.BorderMode.Inset,
        Size = UDim2.new(0, 28, 0, 14),
        ZIndex = 6,
        Parent = ToggleLabel,
    })

    local CheckerFrame = Library:Create('ImageLabel', {
        BorderSizePixel = 0,
        Size = UDim2.new(0, 27, 0, 13),
        ZIndex = 5,
        Image = 'http://www.roblox.com/asset/?id=12977615774',
        Visible = not not settings.Transparency,
        Parent = DisplayFrame,
    })

    -- Simple color picker popup (just a button that cycles colors for demo)
    -- In a full implementation, you'd add a proper HSV picker.
    -- For now, we'll just let it open a simple color dialog.
    DisplayFrame.InputBegan:Connect(function(Input)
        if Input.UserInputType == Enum.UserInputType.MouseButton1 and not Library:MouseIsOverOpenedFrame() then
            -- Toggle a simple color selection (for demo, we'll just cycle red/green/blue)
            if ColorPicker.Value == Color3.new(1,0,0) then
                ColorPicker.Value = Color3.new(0,1,0)
            elseif ColorPicker.Value == Color3.new(0,1,0) then
                ColorPicker.Value = Color3.new(0,0,1)
            else
                ColorPicker.Value = Color3.new(1,0,0)
            end
            DisplayFrame.BackgroundColor3 = ColorPicker.Value
            DisplayFrame.BorderColor3 = Library:GetDarkerColor(ColorPicker.Value)
            Library:SafeCallback(ColorPicker.Callback, ColorPicker.Value)
        end
    end)

    function ColorPicker:SetValueRGB(color, transparency)
        self.Value = color
        self.Transparency = transparency or 0
        DisplayFrame.BackgroundColor3 = color
        DisplayFrame.BorderColor3 = Library:GetDarkerColor(color)
        Library:SafeCallback(self.Callback, color)
    end

    Options[settings.Flag] = ColorPicker
    self.Addons = self.Addons or {}
    table.insert(self.Addons, ColorPicker)
    return self
end

-- KeyPicker (fixed)
function BaseAddons:AddKeyPicker(settings)
    local self = self
    local ToggleLabel = self.TextLabel
    local Container = self.Container

    assert(settings.Default, 'AddKeyPicker: Missing default value.')

    local KeyPicker = {
        Value = settings.Default,
        Toggled = false,
        Mode = settings.Mode or 'Toggle',
        Type = 'KeyPicker',
        Callback = settings.Callback or function(v) end,
        ChangedCallback = settings.ChangedCallback or function(k) end,
        NoUI = settings.NoUI,
        SyncToggleState = settings.SyncToggleState or false,
        Parent = self,
        Connections = {},
        Idx = settings.Flag,
    }

    if KeyPicker.SyncToggleState then
        settings.Modes = { 'Toggle' }
        settings.Mode = 'Toggle'
    end

    local PickOuter = Library:Create('Frame', {
        BackgroundColor3 = Color3.new(0, 0, 0),
        BorderColor3 = Color3.new(0, 0, 0),
        Size = UDim2.new(0, 28, 0, 15),
        ZIndex = 6,
        Parent = ToggleLabel,
    })

    local PickInner = Library:Create('Frame', {
        BackgroundColor3 = Library.BackgroundColor,
        BorderColor3 = Library.OutlineColor,
        BorderMode = Enum.BorderMode.Inset,
        Size = UDim2.new(1, 0, 1, 0),
        ZIndex = 7,
        Parent = PickOuter,
    })

    Library:AddToRegistry(PickInner, {
        BackgroundColor3 = 'BackgroundColor',
        BorderColor3 = 'OutlineColor',
    })

    local DisplayLabel = Library:CreateLabel({
        Size = UDim2.new(1, 0, 1, 0),
        TextSize = 13,
        Text = settings.Default,
        TextWrapped = true,
        ZIndex = 8,
        Parent = PickInner,
    })

    -- Context menu for mode selection
    local contextmenu = Library:AddContextMenu(PickOuter)
    local Modes = settings.Modes or { 'Always', 'Toggle', 'Hold' }
    local buttons = {}
    for _, mode in ipairs(Modes) do
        local btn = contextmenu:AddOption(mode, function()
            KeyPicker.Mode = mode
            for m, b in pairs(buttons) do
                b.TextColor3 = (m == mode) and Library.AccentColor or Library.FontColor
            end
            Library:AttemptSave()
        end)
        buttons[mode] = btn
    end
    contextmenu:AddOption('Copy Flag', function()
        pcall(setclipboard, KeyPicker.Idx)
        Library:Notify('Copied flag to clipboard!', 2)
        contextmenu:Hide()
    end)

    for mode, btn in pairs(buttons) do
        btn.TextColor3 = (mode == KeyPicker.Mode) and Library.AccentColor or Library.FontColor
    end

    -- Keybind list label
    local ContainerLabel = Library:CreateLabel({
        TextXAlignment = Enum.TextXAlignment.Left,
        Size = UDim2.new(1, 0, 0, 18),
        TextSize = 13,
        Visible = false,
        ZIndex = 110,
        Parent = Library.KeybindContainer,
    }, true)

    local function updateDisplay(state)
        local mode = KeyPicker.Mode
        if KeyPicker.Override then mode = "Override" end
        ContainerLabel.Text = string.format('[%s] %s (%s)', KeyPicker.Value, settings.Text, mode)
        ContainerLabel.Visible = true
        ContainerLabel.TextColor3 = state and Library.AccentColor or Library.FontColor
        Library.RegistryMap[ContainerLabel].Properties.TextColor3 = state and 'AccentColor' or 'FontColor'
    end

    function KeyPicker:Update()
        if not self.NoUI then
            local mode = Library.KeypickerListMode
            local state = self:GetState()
            if mode == "Active" and self.Parent.Type == "Toggle" and (not state or not self.Parent.Value) then
                ContainerLabel.Visible = false
            elseif mode == "Toggled" and self.Parent.Type == "Toggle" and not self.Parent.Value then
                ContainerLabel.Visible = false
            else
                updateDisplay(state)
            end
        else
            ContainerLabel.Visible = false
        end

        -- Resize keybind list
        local ySize, xSize = 0, 0
        for _, lbl in ipairs(Library.KeybindContainer:GetChildren()) do
            if lbl:IsA('TextLabel') and lbl.Visible then
                ySize = ySize + 18
                if lbl.TextBounds.X > xSize then
                    xSize = lbl.TextBounds.X
                end
            end
        end
        Library.KeybindFrame.Size = UDim2.new(0, math.max(xSize + 10, 210), 0, ySize + 23)
        Library.KeybindFrame.Visible = Library.KeypickerListVisible and (ySize ~= 0)
    end

    function KeyPicker:GetState()
        if self.Mode == 'Always' then return true end
        local key = self.Value
        if key == 'None' then return false end
        if self.Mode == 'Hold' then
            if key == 'MB1' then return UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton1)
            elseif key == 'MB2' then return UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton2)
            else return UserInputService:IsKeyDown(Enum.KeyCode[key]) end
        else
            return self.Toggled
        end
    end

    function KeyPicker:SetValue(data)
        local key, mode = data[1], data[2]
        DisplayLabel.Text = key
        self.Value, self.Mode = key, mode
        for m, btn in pairs(buttons) do
            btn.TextColor3 = (m == mode) and Library.AccentColor or Library.FontColor
        end
        self:Update()
    end

    function KeyPicker:DoClick()
        if self.Override then
            self.Override = false
            self.Toggled = false
        end
        if self.Parent.Type == 'Toggle' and self.SyncToggleState then
            self.Parent:SetValue(not self.Parent.Value)
        end
        Library:SafeCallback(self.Callback, self.Toggled)
    end

    function KeyPicker:SetupConnection(c)
        table.insert(self.Connections, c)
        Library:GiveSignal(c)
    end

    function KeyPicker:Remove()
        Options[settings.Flag] = nil
        for _, conn in ipairs(self.Connections) do
            conn:Disconnect()
        end
        PickOuter:Destroy()
        ContainerLabel:Destroy()
    end

    local picking = false
    PickOuter.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 and not Library:MouseIsOverOpenedFrame() then
            picking = true
            DisplayLabel.Text = '...'
            local event
            event = UserInputService.InputBegan:Connect(function(inp)
                local key
                if inp.UserInputType == Enum.UserInputType.Keyboard then
                    key = (inp.KeyCode == Enum.KeyCode.Escape) and '...' or inp.KeyCode.Name
                elseif inp.UserInputType == Enum.UserInputType.MouseButton1 then
                    key = 'MB1'
                elseif inp.UserInputType == Enum.UserInputType.MouseButton2 then
                    key = 'MB2'
                else
                    return
                end
                picking = false
                DisplayLabel.Text = key
                KeyPicker.Value = key
                Library:SafeCallback(KeyPicker.ChangedCallback, key)
                Library:SafeCallback(KeyPicker.Changed, key)
                Library:AttemptSave()
                event:Disconnect()
            end)
            task.wait(0.2)
        end
    end)

    KeyPicker:SetupConnection(UserInputService.InputBegan:Connect(function(input, processed)
        if not picking and not processed then
            if KeyPicker.Mode == 'Toggle' then
                local key = KeyPicker.Value
                if key == 'MB1' and input.UserInputType == Enum.UserInputType.MouseButton1 then
                    KeyPicker.Toggled = not KeyPicker.Toggled
                    KeyPicker:DoClick()
                elseif key == 'MB2' and input.UserInputType == Enum.UserInputType.MouseButton2 then
                    KeyPicker.Toggled = not KeyPicker.Toggled
                    KeyPicker:DoClick()
                elseif input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode.Name == key then
                    KeyPicker.Toggled = not KeyPicker.Toggled
                    KeyPicker:DoClick()
                end
            end
            KeyPicker:Update()
        end
    end))

    KeyPicker:SetupConnection(UserInputService.InputEnded:Connect(function()
        if not picking then KeyPicker:Update() end
    end))

    KeyPicker:Update()
    Options[settings.Flag] = KeyPicker
    self.Addons = self.Addons or {}
    table.insert(self.Addons, KeyPicker)
    return self
end

-- ------------------------------------------------------------------
-- Element base
-- ------------------------------------------------------------------
local Element = {}
Element.__index = Element

function Element:SetVisible(visible)
    if self.Container then
        self.Container.Visible = visible
    end
end

function Element:SetValue(value)
    self.Value = value
    if self.Flag then
        Toggles[self.Flag] = value
        Options[self.Flag] = value
    end
    if self.Callback then
        Library:SafeCallback(self.Callback, value)
    end
end

-- ------------------------------------------------------------------
-- Toggle
-- ------------------------------------------------------------------
local Toggle = setmetatable({}, { __index = Element })
Toggle.__index = Toggle

function Toggle.new(parent, settings)
    local self = setmetatable({}, Toggle)
    self.Type = "Toggle"
    self.Flag = settings.Flag
    self.Text = settings.Text or "Toggle"
    self.Default = settings.Default or false
    self.Callback = settings.Callback or function() end
    self.Parent = parent
    self.Dependencies = {}
    self.Container = Library:Create('Frame', {
        Size = UDim2.new(1, -10, 0, 25),
        BackgroundTransparency = 1,
        Parent = parent.Content,
    })

    local ToggleOuter = Library:Create('Frame', {
        BackgroundColor3 = Color3.new(0, 0, 0),
        BorderColor3 = Color3.new(0, 0, 0),
        Size = UDim2.new(0, 13, 0, 13),
        ZIndex = 5,
        Parent = self.Container,
    })

    Library:AddToRegistry(ToggleOuter, { BorderColor3 = 'Black' })

    local ToggleInner = Library:Create('Frame', {
        BackgroundColor3 = Library.MainColor,
        BorderColor3 = Library.OutlineColor,
        BorderMode = Enum.BorderMode.Inset,
        Size = UDim2.new(1, 0, 1, 0),
        ZIndex = 6,
        Parent = ToggleOuter,
    })

    Library:AddToRegistry(ToggleInner, {
        BackgroundColor3 = 'MainColor',
        BorderColor3 = 'OutlineColor',
    })

    self.Check = Library:Create('Frame', {
        BackgroundColor3 = Library.AccentColor,
        BorderSizePixel = 0,
        Size = UDim2.new(1, -4, 1, -4),
        Position = UDim2.new(0, 2, 0, 2),
        Visible = self.Default,
        ZIndex = 7,
        Parent = ToggleInner,
    })

    local ToggleLabel = Library:CreateLabel({
        Size = UDim2.new(0, 216, 1, 0),
        Position = UDim2.new(1, 6, 0, 0),
        TextSize = 14,
        Text = self.Text,
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 6,
        Parent = ToggleOuter,
    })
    self.TextLabel = ToggleLabel

    Library:Create('UIListLayout', {
        Padding = UDim.new(0, 4),
        FillDirection = Enum.FillDirection.Horizontal,
        HorizontalAlignment = Enum.HorizontalAlignment.Right,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Parent = ToggleLabel,
    })

    local ToggleRegion = Library:Create('Frame', {
        BackgroundTransparency = 1,
        Size = UDim2.new(0, 170, 1, 0),
        ZIndex = 8,
        Parent = ToggleOuter,
    })

    Library:OnHighlight(ToggleRegion, ToggleOuter,
        { BorderColor3 = 'AccentColor' },
        { BorderColor3 = 'Black' }
    )

    self.Value = self.Default
    Toggles[self.Flag] = self.Value
    Options[self.Flag] = self.Value

    ToggleRegion.InputBegan:Connect(function(Input)
        if Input.UserInputType == Enum.UserInputType.MouseButton1 and not Library:MouseIsOverOpenedFrame() then
            self:SetValue(not self.Value)
            self.Check.Visible = self.Value
            ToggleInner.BackgroundColor3 = self.Value and Library.AccentColor or Library.MainColor
            ToggleInner.BorderColor3 = self.Value and Library.AccentColorDark or Library.OutlineColor
            Library.RegistryMap[ToggleInner].Properties.BackgroundColor3 = self.Value and 'AccentColor' or 'MainColor'
            Library.RegistryMap[ToggleInner].Properties.BorderColor3 = self.Value and 'AccentColorDark' or 'OutlineColor'
            Library:UpdateDependencyBoxes()
            Library:AttemptSave()
        end
    end)

    -- Context menu
    local contextmenu = Library:AddContextMenu(ToggleOuter, ToggleRegion)
    contextmenu:AddOption('Copy Flag', function()
        pcall(setclipboard, self.Flag)
        Library:Notify('Copied flag to clipboard!', 2)
        contextmenu:Hide()
    end)

    if settings.Risky then
        Library:RemoveFromRegistry(ToggleLabel)
        ToggleLabel.TextColor3 = Library.RiskColor
        Library:AddToRegistry(ToggleLabel, { TextColor3 = 'RiskColor' })
    end

    self:SetValue(self.Default) -- ensure display matches

    parent:AddBlank(5)
    parent:Resize()

    self.Addons = {}
    setmetatable(self, BaseAddons)

    return self
end

-- ------------------------------------------------------------------
-- Slider
-- ------------------------------------------------------------------
local Slider = setmetatable({}, { __index = Element })
Slider.__index = Slider

function Slider.new(parent, settings)
    local self = setmetatable({}, Slider)
    self.Flag = settings.Flag
    self.Text = settings.Text or "Slider"
    self.Min = settings.Min or 0
    self.Max = settings.Max or 100
    self.Default = settings.Default or 50
    self.Rounding = settings.Rounding or 0
    self.Suffix = settings.Suffix or ""
    self.Callback = settings.Callback or function() end
    self.Parent = parent
    self.Container = Library:Create('Frame', {
        Size = UDim2.new(1, -10, 0, 40),
        BackgroundTransparency = 1,
        Parent = parent.Content,
    })

    local label = Library:CreateLabel({
        Size = UDim2.new(0, 150, 0, 20),
        BackgroundTransparency = 1,
        Text = self.Text,
        TextColor3 = Library.FontColor,
        Font = Library.Font,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = self.Container,
    })
    Library:AddToRegistry(label, { TextColor3 = 'FontColor' })

    self.ValueDisplay = Library:CreateLabel({
        Size = UDim2.new(0, 50, 0, 20),
        Position = UDim2.new(1, -50, 0, 0),
        Text = tostring(self.Default) .. self.Suffix,
        TextColor3 = Library.FontColor,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Right,
        Parent = self.Container,
    })
    Library:AddToRegistry(self.ValueDisplay, { TextColor3 = 'FontColor' })

    local SliderOuter = Library:Create('Frame', {
        BackgroundColor3 = Color3.new(0, 0, 0),
        BorderColor3 = Color3.new(0, 0, 0),
        Size = UDim2.new(1, 0, 0, 13),
        Position = UDim2.new(0, 0, 0, 25),
        ZIndex = 5,
        Parent = self.Container,
    })
    Library:AddToRegistry(SliderOuter, { BorderColor3 = 'Black' })

    local SliderInner = Library:Create('Frame', {
        BackgroundColor3 = Library.MainColor,
        BorderColor3 = Library.OutlineColor,
        BorderMode = Enum.BorderMode.Inset,
        Size = UDim2.new(1, 0, 1, 0),
        ZIndex = 6,
        Parent = SliderOuter,
    })
    Library:AddToRegistry(SliderInner, {
        BackgroundColor3 = 'MainColor',
        BorderColor3 = 'OutlineColor',
    })

    self.Fill = Library:Create('Frame', {
        BackgroundColor3 = Library.AccentColor,
        BorderColor3 = Library.AccentColorDark,
        Size = UDim2.new(0, 0, 1, 0),
        ZIndex = 7,
        Parent = SliderInner,
    })
    Library:AddToRegistry(self.Fill, {
        BackgroundColor3 = 'AccentColor',
        BorderColor3 = 'AccentColorDark',
    })

    Library:OnHighlight(SliderOuter, SliderOuter,
        { BorderColor3 = 'AccentColor' },
        { BorderColor3 = 'Black' }
    )

    self.Value = self.Default
    Toggles[self.Flag] = self.Value
    Options[self.Flag] = self.Value

    local maxWidth = SliderOuter.AbsoluteSize.X - 2
    local function updateFill()
        local percent = (self.Value - self.Min) / (self.Max - self.Min)
        local width = percent * maxWidth
        self.Fill.Size = UDim2.new(0, width, 1, 0)
        self.ValueDisplay.Text = tostring(self.Value) .. self.Suffix
    end

    local dragging = false
    SliderInner.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 and not Library:MouseIsOverOpenedFrame() then
            dragging = true
            while dragging do
                local mouseX = Mouse.X
                local absX = SliderInner.AbsolutePosition.X
                local relX = math.clamp(mouseX - absX, 0, maxWidth)
                local val = self.Min + (relX / maxWidth) * (self.Max - self.Min)
                if self.Rounding then
                    val = Library:Round(val, self.Rounding)
                end
                self:SetValue(val)
                RunService.RenderStepped:Wait()
            end
        end
    end)

    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
            Library:AttemptSave()
        end
    end)

    function self:SetValue(val)
        val = math.clamp(val, self.Min, self.Max)
        self.Value = val
        Toggles[self.Flag] = val
        Options[self.Flag] = val
        updateFill()
        Library:SafeCallback(self.Callback, val)
    end

    self:SetValue(self.Default)

    parent:AddBlank(6)
    parent:Resize()

    return self
end

-- ------------------------------------------------------------------
-- Dropdown
-- ------------------------------------------------------------------
local Dropdown = setmetatable({}, { __index = Element })
Dropdown.__index = Dropdown

function Dropdown.new(parent, settings)
    local self = setmetatable({}, Dropdown)
    self.Flag = settings.Flag
    self.Text = settings.Text or "Dropdown"
    self.Values = settings.Values or {}
    self.Default = settings.Default or (self.Values[1] or "")
    self.Multi = settings.Multi or false
    self.Callback = settings.Callback or function() end
    self.Parent = parent
    self.Container = Library:Create('Frame', {
        Size = UDim2.new(1, -10, 0, 30),
        BackgroundTransparency = 1,
        Parent = parent.Content,
    })

    local label = Library:CreateLabel({
        Size = UDim2.new(0, 150, 1, 0),
        Text = self.Text,
        TextColor3 = Library.FontColor,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = self.Container,
    })
    Library:AddToRegistry(label, { TextColor3 = 'FontColor' })

    self.DropBtn = Library:Create('TextButton', {
        Size = UDim2.new(0, 120, 0, 20),
        Position = UDim2.new(1, -120, 0.5, -10),
        BackgroundColor3 = Library.MainColor,
        BorderColor3 = Library.OutlineColor,
        BorderMode = Enum.BorderMode.Inset,
        Text = self.Multi and "Select" or tostring(self.Default),
        TextColor3 = Library.FontColor,
        Font = Library.Font,
        TextSize = 14,
        ZIndex = 6,
        Parent = self.Container,
    })
    Library:AddToRegistry(self.DropBtn, { BackgroundColor3 = 'MainColor', BorderColor3 = 'OutlineColor', TextColor3 = 'FontColor' })

    local arrow = Library:Create('ImageLabel', {
        AnchorPoint = Vector2.new(0, 0.5),
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -16, 0.5, 0),
        Size = UDim2.new(0, 12, 0, 12),
        Image = 'http://www.roblox.com/asset/?id=6282522798',
        ZIndex = 8,
        Parent = self.DropBtn,
    })

    self.DropdownFrame = Library:Create('Frame', {
        BackgroundColor3 = Library.BackgroundColor,
        BorderColor3 = Library.OutlineColor,
        BorderMode = Enum.BorderMode.Inset,
        Size = UDim2.new(0, 120, 0, 0),
        Position = UDim2.new(1, -120, 0, 20),
        ClipsDescendants = true,
        Visible = false,
        ZIndex = 10,
        Parent = self.Container,
    })
    Library:AddToRegistry(self.DropdownFrame, { BackgroundColor3 = 'BackgroundColor', BorderColor3 = 'OutlineColor' })

    local list = Library:Create('UIListLayout', {
        FillDirection = Enum.FillDirection.Vertical,
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        VerticalAlignment = Enum.VerticalAlignment.Top,
        Padding = UDim.new(0, 2),
        Parent = self.DropdownFrame,
    })

    self.Value = self.Multi and {} or self.Default
    Toggles[self.Flag] = self.Value
    Options[self.Flag] = self.Value

    local function refreshDropdown()
        for _, child in ipairs(self.DropdownFrame:GetChildren()) do
            if child:IsA('TextButton') then child:Destroy() end
        end
        for _, val in ipairs(self.Values) do
            local btn = Library:Create('TextButton', {
                Size = UDim2.new(1, 0, 0, 20),
                BackgroundColor3 = Library.MainColor,
                BorderColor3 = Library.OutlineColor,
                BorderMode = Enum.BorderMode.Inset,
                Text = tostring(val),
                TextColor3 = Library.FontColor,
                Font = Library.Font,
                TextSize = 14,
                ZIndex = 12,
                Parent = self.DropdownFrame,
            })
            Library:AddToRegistry(btn, { BackgroundColor3 = 'MainColor', BorderColor3 = 'OutlineColor', TextColor3 = 'FontColor' })
            btn.MouseButton1Click:Connect(function()
                if self.Multi then
                    if self.Value[val] then
                        self.Value[val] = nil
                    else
                        self.Value[val] = true
                    end
                    self.DropBtn.Text = "Selected"
                else
                    self.Value = val
                    self.DropBtn.Text = tostring(val)
                    self.DropdownFrame.Visible = false
                    arrow.Rotation = 0
                end
                Toggles[self.Flag] = self.Value
                Options[self.Flag] = self.Value
                Library:SafeCallback(self.Callback, self.Value)
            end)
        end
        self.DropdownFrame.Size = UDim2.new(0, 120, 0, math.min(#self.Values * 22, 150))
    end

    self.DropBtn.MouseButton1Click:Connect(function()
        self.DropdownFrame.Visible = not self.DropdownFrame.Visible
        arrow.Rotation = self.DropdownFrame.Visible and 180 or 0
        if self.DropdownFrame.Visible then
            refreshDropdown()
        end
    end)

    Library:BindToInput(Enum.UserInputType.MouseButton1, function()
        if self.DropdownFrame.Visible and not Library:IsMouseOverFrame(self.DropdownFrame) then
            self.DropdownFrame.Visible = false
            arrow.Rotation = 0
        end
    end)

    local contextmenu = Library:AddContextMenu(self.DropBtn)
    contextmenu:AddOption('Copy Flag', function()
        pcall(setclipboard, self.Flag)
        Library:Notify('Copied flag to clipboard!', 2)
        contextmenu:Hide()
    end)

    refreshDropdown()
    parent:AddBlank(5)
    parent:Resize()

    return self
end

-- ------------------------------------------------------------------
-- Input
-- ------------------------------------------------------------------
local Input = setmetatable({}, { __index = Element })
Input.__index = Input

function Input.new(parent, settings)
    local self = setmetatable({}, Input)
    self.Flag = settings.Flag
    self.Text = settings.Text or "Input"
    self.Placeholder = settings.Placeholder or ""
    self.Numeric = settings.Numeric or false
    self.Callback = settings.Callback or function() end
    self.Parent = parent
    self.Container = Library:Create('Frame', {
        Size = UDim2.new(1, -10, 0, 30),
        BackgroundTransparency = 1,
        Parent = parent.Content,
    })

    local label = Library:CreateLabel({
        Size = UDim2.new(0, 150, 1, 0),
        Text = self.Text,
        TextColor3 = Library.FontColor,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = self.Container,
    })
    Library:AddToRegistry(label, { TextColor3 = 'FontColor' })

    local BoxOuter = Library:Create('Frame', {
        BackgroundColor3 = Color3.new(0, 0, 0),
        BorderColor3 = Color3.new(0, 0, 0),
        Size = UDim2.new(0, 120, 0, 20),
        Position = UDim2.new(1, -120, 0.5, -10),
        ZIndex = 5,
        Parent = self.Container,
    })
    Library:AddToRegistry(BoxOuter, { BorderColor3 = 'Black' })

    local BoxInner = Library:Create('Frame', {
        BackgroundColor3 = Library.MainColor,
        BorderColor3 = Library.OutlineColor,
        BorderMode = Enum.BorderMode.Inset,
        Size = UDim2.new(1, 0, 1, 0),
        ZIndex = 6,
        Parent = BoxOuter,
    })
    Library:AddToRegistry(BoxInner, { BackgroundColor3 = 'MainColor', BorderColor3 = 'OutlineColor' })

    local Box = Library:Create('TextBox', {
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 2, 0, 0),
        Size = UDim2.new(1, -4, 1, 0),
        Font = Library.Font,
        PlaceholderColor3 = Color3.fromRGB(190, 190, 190),
        PlaceholderText = self.Placeholder,
        Text = "",
        TextColor3 = Library.FontColor,
        TextSize = 14,
        ClearTextOnFocus = false,
        ZIndex = 7,
        Parent = BoxInner,
    })
    Library:AddToRegistry(Box, { TextColor3 = 'FontColor' })
    Library:ApplyTextStroke(Box)

    self.Value = ""
    Toggles[self.Flag] = self.Value
    Options[self.Flag] = self.Value

    Box.FocusLost:Connect(function(enter)
        local text = Box.Text
        if self.Numeric then
            text = tonumber(text) or 0
        end
        self.Value = text
        Toggles[self.Flag] = text
        Options[self.Flag] = text
        Library:SafeCallback(self.Callback, text)
    end)

    local contextmenu = Library:AddContextMenu(BoxOuter)
    contextmenu:AddOption('Copy Flag', function()
        pcall(setclipboard, self.Flag)
        Library:Notify('Copied flag to clipboard!', 2)
        contextmenu:Hide()
    end)

    parent:AddBlank(5)
    parent:Resize()

    return self
end

-- ------------------------------------------------------------------
-- Button
-- ------------------------------------------------------------------
local Button = setmetatable({}, { __index = Element })
Button.__index = Button

function Button.new(parent, settings)
    local self = setmetatable({}, Button)
    self.Text = settings.Text or "Button"
    self.Func = settings.Func or function() end
    self.Container = Library:Create('Frame', {
        Size = UDim2.new(1, -10, 0, 25),
        BackgroundTransparency = 1,
        Parent = parent.Content,
    })

    local Outer = Library:Create('Frame', {
        BackgroundColor3 = Color3.new(0, 0, 0),
        BorderColor3 = Color3.new(0, 0, 0),
        Size = UDim2.new(0, 100, 0, 20),
        Position = UDim2.new(0.5, -50, 0, 2.5),
        ZIndex = 5,
        Parent = self.Container,
    })
    Library:AddToRegistry(Outer, { BorderColor3 = 'Black' })

    local Inner = Library:Create('Frame', {
        BackgroundColor3 = Library.MainColor,
        BorderColor3 = Library.OutlineColor,
        BorderMode = Enum.BorderMode.Inset,
        Size = UDim2.new(1, 0, 1, 0),
        ZIndex = 6,
        Parent = Outer,
    })
    Library:AddToRegistry(Inner, { BackgroundColor3 = 'MainColor', BorderColor3 = 'OutlineColor' })

    local Label = Library:CreateLabel({
        Size = UDim2.new(1, 0, 1, 0),
        Text = self.Text,
        TextColor3 = Library.FontColor,
        TextSize = 14,
        ZIndex = 7,
        Parent = Inner,
    })
    Library:AddToRegistry(Label, { TextColor3 = 'FontColor' })

    Library:OnHighlight(Outer, Outer,
        { BorderColor3 = 'AccentColor' },
        { BorderColor3 = 'Black' }
    )

    Outer.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 and not Library:MouseIsOverOpenedFrame() then
            Library:SafeCallback(self.Func)
        end
    end)

    parent:AddBlank(5)
    parent:Resize()

    return self
end

-- ------------------------------------------------------------------
-- Label
-- ------------------------------------------------------------------
local Label = setmetatable({}, { __index = Element })
Label.__index = Label

function Label.new(parent, settings)
    local self = setmetatable({}, Label)
    self.Text = settings.Text or ""
    self.Container = Library:Create('Frame', {
        Size = UDim2.new(1, -10, 0, 20),
        BackgroundTransparency = 1,
        Parent = parent.Content,
    })

    self.Label = Library:CreateLabel({
        Size = UDim2.new(1, 0, 1, 0),
        Text = self.Text,
        TextColor3 = Library.FontColor,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = self.Container,
    })
    Library:AddToRegistry(self.Label, { TextColor3 = 'FontColor' })

    parent:Resize()
    return self
end

function Label:SetText(text)
    self.Label.Text = text
end

-- ------------------------------------------------------------------
-- Divider
-- ------------------------------------------------------------------
local Divider = setmetatable({}, { __index = Element })
Divider.__index = Divider

function Divider.new(parent, settings)
    local self = setmetatable({}, Divider)
    self.Text = settings.Text or ""
    self.Container = Library:Create('Frame', {
        Size = UDim2.new(1, -10, 0, 20),
        BackgroundTransparency = 1,
        Parent = parent.Content,
    })

    local line = Library:Create('Frame', {
        Size = UDim2.new(1, 0, 0, 1),
        Position = UDim2.new(0, 0, 0.5, 0),
        BackgroundColor3 = Library.OutlineColor,
        BorderSizePixel = 0,
        Parent = self.Container,
    })
    Library:AddToRegistry(line, { BackgroundColor3 = 'OutlineColor' })

    if self.Text ~= "" then
        local lbl = Library:CreateLabel({
            Size = UDim2.new(0, #self.Text * 8, 1, 0),
            Position = UDim2.new(0.5, - (#self.Text * 4), 0, 0),
            Text = self.Text,
            TextColor3 = Library.FontColor,
            TextSize = 12,
            Parent = self.Container,
        })
        Library:AddToRegistry(lbl, { TextColor3 = 'FontColor' })
    end

    parent:Resize()
    return self
end

-- ------------------------------------------------------------------
-- Groupbox (base)
-- ------------------------------------------------------------------
local Groupbox = {}
Groupbox.__index = Groupbox

function Groupbox.new(parent, name, side)
    local self = setmetatable({}, Groupbox)
    self.Name = name
    self.Side = side or "left"
    self.Elements = {}
    self.Dependencies = {}

    self.Frame = Library:Create('Frame', {
        BackgroundColor3 = Library.BackgroundColor,
        BorderColor3 = Library.OutlineColor,
        BorderMode = Enum.BorderMode.Inset,
        Size = UDim2.new(0.5, -10, 0, 200),
        ZIndex = 2,
        Parent = parent.Page,
    })
    Library:AddToRegistry(self.Frame, { BackgroundColor3 = 'BackgroundColor', BorderColor3 = 'OutlineColor' })

    local title = Library:CreateLabel({
        Size = UDim2.new(1, 0, 0, 20),
        BackgroundColor3 = Library.MainColor,
        BorderColor3 = Library.OutlineColor,
        BorderMode = Enum.BorderMode.Inset,
        Text = name,
        TextColor3 = Library.FontColor,
        TextSize = 14,
        ZIndex = 3,
        Parent = self.Frame,
    })
    Library:AddToRegistry(title, { BackgroundColor3 = 'MainColor', BorderColor3 = 'OutlineColor', TextColor3 = 'FontColor' })

    self.Content = Library:Create('ScrollingFrame', {
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 1, -20),
        Position = UDim2.new(0, 0, 0, 20),
        ScrollBarThickness = 4,
        CanvasSize = UDim2.new(0,0,0,0),
        AutomaticCanvasSize = Enum.AutomaticSize.Y,
        ZIndex = 4,
        Parent = self.Frame,
    })

    local layout = Library:Create('UIListLayout', {
        FillDirection = Enum.FillDirection.Vertical,
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        VerticalAlignment = Enum.VerticalAlignment.Top,
        Padding = UDim.new(0, 5),
        Parent = self.Content,
    })

    layout:GetPropertyChangedSignal('AbsoluteContentSize'):Connect(function()
        self.Content.CanvasSize = UDim2.new(0,0,0, layout.AbsoluteContentSize.Y + 10)
    end)

    function self:Resize()
        -- nothing needed, layout handles size
    end

    return self
end

function Groupbox:AddBlank(height)
    return Library:Create('Frame', {
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, height),
        Parent = self.Content,
    })
end

function Groupbox:AddToggle(settings)
    local toggle = Toggle.new(self, settings)
    table.insert(self.Elements, toggle)
    return toggle
end

function Groupbox:AddSlider(settings)
    local slider = Slider.new(self, settings)
    table.insert(self.Elements, slider)
    return slider
end

function Groupbox:AddDropdown(settings)
    local dropdown = Dropdown.new(self, settings)
    table.insert(self.Elements, dropdown)
    return dropdown
end

function Groupbox:AddInput(settings)
    local input = Input.new(self, settings)
    table.insert(self.Elements, input)
    return input
end

function Groupbox:AddButton(settings)
    local btn = Button.new(self, settings)
    table.insert(self.Elements, btn)
    return btn
end

function Groupbox:AddLabel(settings)
    local lbl = Label.new(self, settings)
    table.insert(self.Elements, lbl)
    return lbl
end

function Groupbox:AddDivider(settings)
    local div = Divider.new(self, settings)
    table.insert(self.Elements, div)
    return div
end

function Groupbox:AddDependencyBox()
    local depBox = Library:Create('Frame', {
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -10, 0, 0),
        Parent = self.Content,
        Visible = true,
    })
    local layout = Library:Create('UIListLayout', {
        FillDirection = Enum.FillDirection.Vertical,
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        VerticalAlignment = Enum.VerticalAlignment.Top,
        Padding = UDim.new(0, 5),
        Parent = depBox,
    })
    local box = {
        Frame = depBox,
        Content = depBox,
        Elements = {},
        AddToggle = function(_, s) local t = Toggle.new({Content=depBox}, s); table.insert(box.Elements, t); return t end,
        AddSlider = function(_, s) local sl = Slider.new({Content=depBox}, s); table.insert(box.Elements, sl); return sl end,
        AddDropdown = function(_, s) local dd = Dropdown.new({Content=depBox}, s); table.insert(box.Elements, dd); return dd end,
        AddInput = function(_, s) local inp = Input.new({Content=depBox}, s); table.insert(box.Elements, inp); return inp end,
        AddButton = function(_, s) local btn = Button.new({Content=depBox}, s); table.insert(box.Elements, btn); return btn end,
        AddLabel = function(_, s) local lbl = Label.new({Content=depBox}, s); table.insert(box.Elements, lbl); return lbl end,
        AddDivider = function(_, s) local div = Divider.new({Content=depBox}, s); table.insert(box.Elements, div); return div end,
    }
    table.insert(Library.DependencyBoxes, box)
    return box
end

-- ------------------------------------------------------------------
-- Tab
-- ------------------------------------------------------------------
local Tab = {}
Tab.__index = Tab

function Tab.new(window, name)
    local self = setmetatable({}, Tab)
    self.Name = name
    self.Window = window
    self.Groupboxes = {}

    self.Button = Library:Create('TextButton', {
        Size = UDim2.new(0, 80, 0, 25),
        BackgroundColor3 = Library.MainColor,
        BorderColor3 = Library.OutlineColor,
        BorderMode = Enum.BorderMode.Inset,
        Text = name,
        TextColor3 = Library.FontColor,
        Font = Library.Font,
        TextSize = 14,
        ZIndex = 5,
        Parent = window.TabsBar,
    })
    Library:AddToRegistry(self.Button, { BackgroundColor3 = 'MainColor', BorderColor3 = 'OutlineColor', TextColor3 = 'FontColor' })

    self.Page = Library:Create('ScrollingFrame', {
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 1, 0),
        ScrollBarThickness = 6,
        Visible = false,
        Parent = window.Pages,
        CanvasSize = UDim2.new(0,0,0,0),
        AutomaticCanvasSize = Enum.AutomaticSize.Y,
    })

    self.Button.MouseButton1Click:Connect(function()
        window:SelectTab(self)
    end)

    return self
end

function Tab:AddLeftGroupbox(name)
    local gb = Groupbox.new(self, name, "left")
    table.insert(self.Groupboxes, gb)
    return gb
end

function Tab:AddRightGroupbox(name)
    local gb = Groupbox.new(self, name, "right")
    table.insert(self.Groupboxes, gb)
    return gb
end

-- ------------------------------------------------------------------
-- Window
-- ------------------------------------------------------------------
local Window = {}
Window.__index = Window

function Window.new(options)
    local self = setmetatable({}, Window)
    self.Title = options.Title or "Library"
    self.Size = options.Size or UDim2.new(0,600,0,400)
    self.Position = options.Center and UDim2.new(0.5,-300,0.5,-200) or options.Position or UDim2.new(0,100,0,100)
    self.Tabs = {}
    self.ActiveTab = nil

    self.GUI = Library.ScreenGui

    self.Main = Library:Create('Frame', {
        Size = self.Size,
        Position = self.Position,
        BackgroundColor3 = Color3.new(0,0,0),
        BorderSizePixel = 0,
        Active = true,
        Parent = self.GUI,
    })
    Library:MakeDraggable(self.Main, 25)

    self.Inner = Library:Create('Frame', {
        BackgroundColor3 = Library.MainColor,
        BorderColor3 = Library.AccentColor,
        BorderMode = Enum.BorderMode.Inset,
        Position = UDim2.new(0, 1, 0, 1),
        Size = UDim2.new(1, -2, 1, -2),
        ZIndex = 1,
        Parent = self.Main,
    })
    Library:AddToRegistry(self.Inner, { BackgroundColor3 = 'MainColor', BorderColor3 = 'AccentColor' })

    self.TitleLabel = Library:CreateLabel({
        Size = UDim2.new(1, 0, 0, 25),
        Text = self.Title,
        TextSize = 16,
        ZIndex = 2,
        Parent = self.Inner,
    })

    self.TabsBar = Library:Create('Frame', {
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -16, 0, 30),
        Position = UDim2.new(0, 8, 0, 25),
        ZIndex = 2,
        Parent = self.Inner,
    })
    Library:Create('UIListLayout', {
        FillDirection = Enum.FillDirection.Horizontal,
        HorizontalAlignment = Enum.HorizontalAlignment.Left,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 5),
        Parent = self.TabsBar,
    })

    self.Pages = Library:Create('Frame', {
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -16, 1, -60),
        Position = UDim2.new(0, 8, 0, 60),
        ZIndex = 2,
        Parent = self.Inner,
    })

    Library.CurrentMenu = self
    return self
end

function Window:AddTab(name)
    local tab = Tab.new(self, name)
    table.insert(self.Tabs, tab)
    if #self.Tabs == 1 then
        self:SelectTab(tab)
    end
    return tab
end

function Window:SelectTab(tab)
    if self.ActiveTab then
        self.ActiveTab.Page.Visible = false
        self.ActiveTab.Button.BackgroundColor3 = Library.MainColor
        Library.RegistryMap[self.ActiveTab.Button].Properties.BackgroundColor3 = 'MainColor'
    end
    tab.Page.Visible = true
    tab.Button.BackgroundColor3 = Library.AccentColor
    Library.RegistryMap[tab.Button].Properties.BackgroundColor3 = 'AccentColor'
    self.ActiveTab = tab
end

-- ------------------------------------------------------------------
-- Save Manager (minimal)
-- ------------------------------------------------------------------
local SaveManager = {}
SaveManager.__index = SaveManager

function SaveManager:SetLibrary(lib)
    self.Library = lib
end

function SaveManager:SetFolder(folder)
    self.Folder = folder
end

function SaveManager:SaveConfig(name)
    local data = {}
    for flag, value in pairs(Options) do
        data[flag] = value
    end
    local json = HttpService:JSONEncode(data)
    if writefile then
        writefile(self.Folder .. "/" .. name .. ".json", json)
        Library:Notify("Config saved", 2)
    else
        Library:Notify("writefile not supported", 2)
    end
end

function SaveManager:LoadConfig(name)
    local file = self.Folder .. "/" .. name .. ".json"
    if isfile and isfile(file) then
        local json = readfile(file)
        local data = HttpService:JSONDecode(json)
        for flag, value in pairs(data) do
            Options[flag] = value
            Toggles[flag] = value
            -- Note: UI updates would require element references; simplified
        end
        Library:Notify("Config loaded", 2)
    else
        Library:Notify("Config not found", 2)
    end
end

-- ------------------------------------------------------------------
-- Theme Manager (minimal)
-- ------------------------------------------------------------------
local ThemeManager = {}
ThemeManager.__index = ThemeManager

function ThemeManager:SetLibrary(lib)
    self.Library = lib
end

function ThemeManager:SetFolder(folder)
    self.Folder = folder
end

function ThemeManager:ApplyToTab(tab)
    local group = tab:AddLeftGroupbox("Theme")
    group:AddButton({Text = "Light Theme", Func = function()
        Library.MainColor = Color3.fromRGB(240,240,240)
        Library.BackgroundColor = Color3.fromRGB(220,220,220)
        Library.OutlineColor = Color3.fromRGB(200,200,200)
        Library.FontColor = Color3.new(0,0,0)
        Library.AccentColor = Color3.fromRGB(0,85,255)
        Library.AccentColorDark = Library:GetDarkerColor(Library.AccentColor)
        Library:UpdateColorsUsingRegistry()
    end})
    group:AddButton({Text = "Dark Theme", Func = function()
        Library.MainColor = Color3.fromRGB(28,28,28)
        Library.BackgroundColor = Color3.fromRGB(20,20,20)
        Library.OutlineColor = Color3.fromRGB(50,50,50)
        Library.FontColor = Color3.new(1,1,1)
        Library.AccentColor = Color3.fromRGB(0,85,255)
        Library.AccentColorDark = Library:GetDarkerColor(Library.AccentColor)
        Library:UpdateColorsUsingRegistry()
    end})
end

-- ------------------------------------------------------------------
-- Helper functions
-- ------------------------------------------------------------------
function Library:CreateLabel(properties, isHud)
    local lbl = self:Create('TextLabel', {
        BackgroundTransparency = 1,
        Font = self.Font,
        TextColor3 = self.FontColor,
        TextSize = 16,
        TextStrokeTransparency = 0,
    })
    self:ApplyTextStroke(lbl)
    self:AddToRegistry(lbl, { TextColor3 = 'FontColor' }, isHud)
    return self:Create(lbl, properties)
end

function Library:ApplyTextStroke(inst)
    inst.TextStrokeTransparency = 1
    self:Create('UIStroke', {
        Color = Color3.new(0,0,0),
        Thickness = 1,
        LineJoinMode = Enum.LineJoinMode.Miter,
        Parent = inst,
    })
end

function Library:OnHighlight(HighlightInstance, Instance, Properties, PropertiesDefault)
    HighlightInstance.MouseEnter:Connect(function()
        local Reg = self.RegistryMap[Instance]
        for Property, ColorIdx in pairs(Properties) do
            Instance[Property] = self[ColorIdx] or ColorIdx
            if Reg and Reg.Properties[Property] then
                Reg.Properties[Property] = ColorIdx
            end
        end
    end)
    HighlightInstance.MouseLeave:Connect(function()
        local Reg = self.RegistryMap[Instance]
        for Property, ColorIdx in pairs(PropertiesDefault) do
            Instance[Property] = self[ColorIdx] or ColorIdx
            if Reg and Reg.Properties[Property] then
                Reg.Properties[Property] = ColorIdx
            end
        end
    end)
end

function Library:BindToInput(key, callback)
    _callbacks = _callbacks or {}
    _callbacks[key] = _callbacks[key] or {}
    table.insert(_callbacks[key], callback)
end

Library:GiveSignal(UserInputService.InputBegan:Connect(function(input, gpe)
    if not _UI_IS_VISIBLE then return end
    local callbacks = _callbacks[input.KeyCode] or _callbacks[input.UserInputType]
    if callbacks then
        for _, cb in ipairs(callbacks) do
            task.spawn(cb, input, gpe)
        end
    end
end))

-- ------------------------------------------------------------------
-- Context Menu
-- ------------------------------------------------------------------
function Library:AddContextMenu(DisplayFrame, hitbox)
    local ContextMenu = { Visible = false, Options = {} }
    ContextMenu.Container = self:Create('Frame', {
        BorderColor3 = Color3.new(),
        ZIndex = 14,
        Visible = false,
        Parent = ScreenGui,
    })
    ContextMenu.Inner = self:Create('Frame', {
        BackgroundColor3 = self.BackgroundColor,
        BorderColor3 = self.OutlineColor,
        BorderMode = Enum.BorderMode.Inset,
        Size = UDim2.fromScale(1, 1),
        ZIndex = 15,
        Parent = ContextMenu.Container,
    })
    self:Create('UIListLayout', {
        HorizontalAlignment = Enum.HorizontalAlignment.Left,
        FillDirection = Enum.FillDirection.Vertical,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Parent = ContextMenu.Inner,
    })
    self:Create('UIPadding', {
        PaddingLeft = UDim.new(0, 0),
        Parent = ContextMenu.Inner,
    })

    local function updateMenuPosition()
        ContextMenu.Container.Position = UDim2.fromOffset(
            DisplayFrame.AbsolutePosition.X + DisplayFrame.AbsoluteSize.X + 4,
            DisplayFrame.AbsolutePosition.Y + 1
        )
    end

    local function updateMenuSize()
        local menuWidth = 60
        for _, label in ipairs(ContextMenu.Inner:GetChildren()) do
            if label:IsA('TextLabel') then
                menuWidth = math.max(menuWidth, label.TextBounds.X)
            end
        end
        ContextMenu.Container.Size = UDim2.fromOffset(
            menuWidth + 8,
            ContextMenu.Inner.Layout.AbsoluteContentSize.Y + 4
        )
    end

    (hitbox or DisplayFrame).InputBegan:Connect(function(Input)
        if Input.UserInputType == Enum.UserInputType.MouseButton2 and not Library:MouseIsOverOpenedFrame() then
            ContextMenu:Show()
        end
    end)

    self:BindToInput(Enum.UserInputType.MouseButton1, function()
        if ContextMenu.Visible and not self:IsMouseOverFrame(ContextMenu.Container) then
            ContextMenu:Hide()
        end
    end)

    function ContextMenu:Show()
        updateMenuPosition()
        updateMenuSize()
        self.Container.Visible = true
        Library.OpenedFrames[self.Container] = true
    end

    function ContextMenu:Hide()
        self.Container.Visible = false
        Library.OpenedFrames[self.Container] = nil
    end

    function ContextMenu:AddOption(str, callback)
        local btn = self:CreateLabel({
            Size = UDim2.new(1, 0, 0, 15),
            TextSize = 13,
            Text = str,
            ZIndex = 16,
            Parent = self.Inner,
            TextXAlignment = Enum.TextXAlignment.Center,
        })
        self:OnHighlight(btn, btn,
            { TextColor3 = 'AccentColor' },
            { TextColor3 = 'FontColor' }
        )
        btn.InputBegan:Connect(function(Input)
            if Input.UserInputType == Enum.UserInputType.MouseButton1 then
                callback()
                self:Hide()
            end
        end)
        return btn
    end

    return ContextMenu
end

-- ------------------------------------------------------------------
-- Exports
-- ------------------------------------------------------------------
Library.CreateWindow = Window.new
Library.SaveManager = SaveManager
Library.ThemeManager = ThemeManager
Library.Notify = Library.Notify

-- ------------------------------------------------------------------
-- Return the library
-- ------------------------------------------------------------------
return Library
